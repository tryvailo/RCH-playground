# Техническое задание для валидации решения Firecrawl

## 1. Общая идея решения

### 1.1 Проблема текущего подхода (Autumna)

RightCareHome использует парсер каталога Autumna для извлечения данных о британских домах престарелых (~5,000 домов). Текущий подход имеет следующие ограничения:

**Неполнота данных:**
- Autumna предоставляет только базовую информацию (8-12 полей): название, адрес, телефон, базовую стоимость, типы ухода
- Отсутствуют критически важные данные:
  - Квалификация персонала (количество сертифицированных медсестёр, сертификаты)
  - Текущее предложение мест
  - Детальные программы деятельности и услуги
  - Фото высокого качества
  - История изменений цен
  - Отзывы семей

**Медленность обновления:**
- Данные обновляются ежемесячно, не ежедневно
- Устаревшая информация может привести к неверным рекомендациям

**Отсутствие контекста:**
- Только базовые данные без глубокого анализа
- Нет возможности отслеживать изменения на сайтах домов престарелых
- Непонятно, откуда Autumna берёт данные и насколько они надёжны

**Пример ограничений:**
Для дома престарелых из Autumna мы получаем:
```json
{
  "name": "Manor House Care Home",
  "address": "123 High Street, Birmingham B10 2PE",
  "phone": "0121 XXX XXXX",
  "specializations": ["dementia", "physical disabilities"],
  "care_types": ["residential", "nursing"],
  "price_range": "£1,000-1,500/week",
  "rating": 4.2
}
```

Отсутствует информация о квалификации персонала, размере палат, меню, часах посещения семьи, программах развлечений, финансовой стабильности.

### 1.2 Решение: Firecrawl для парсинга сайтов домов престарелых

**Концепция:**
Вместо зависимости от ограниченного каталога Autumna, использовать Firecrawl для прямого парсинга официальных сайтов домов престарелых. Это позволяет:

1. **Получать актуальные данные** — парсинг выполняется по запросу, данные всегда свежие
2. **Извлекать глубокую информацию** — со страниц сайтов можно получить 50-100+ полей данных вместо 8-12
3. **Автоматизировать процесс** — полная автоматизация без ручного труда
4. **Отслеживать изменения** — возможность мониторинга изменений на сайтах (цены, персонал, услуги)

**Преимущества подхода:**
- **Охват:** 95%+ домов престарелых имеют собственные сайты (vs 40-50% в Autumna)
- **Обновление:** Ежедневно по запросу (vs ежемесячно в Autumna)
- **Глубина данных:** 50-100+ полей (vs 8-12 в Autumna)
- **Стоимость:** £0.10-0.50 за дом (vs £0, но требует ручного труда стоимостью £3,000/месяц)

**Архитектура решения:**
```
Autumna Catalog (базовые данные) 
    +
Firecrawl (парсинг сайтов домов престарелых)
    +
Google Places API (отзывы, рейтинги, популярность)
    ↓
RightCareHome Unified Database (150+ полей на дом)
```

---

## 2. Логика реализации решения

### 2.1 Архитектура компонентов

Решение реализовано в виде REST API на FastAPI с модульной структурой:

**Основные компоненты:**

1. **Firecrawl API Client** (`api-testing-suite/backend/api_clients/firecrawl_client.py`)
   - Клиент для работы с Firecrawl API v2
   - Методы: `scrape_url`, `crawl_website`, `extract`, `analyze_care_home_website`

2. **API Endpoints** (`api-testing-suite/backend/main.py`)
   - `/api/firecrawl/analyze` — анализ сайта дома престарелых
   - `/api/firecrawl/scrape` — парсинг одной страницы
   - `/api/firecrawl/crawl` — обход всего сайта
   - `/api/firecrawl/extract` — извлечение структурированных данных
   - `/api/firecrawl/unified-analysis` — комплексный анализ с интеграцией Google Places

### 2.2 Логика работы решения

#### 2.2.1 Анализ сайта дома престарелых (`/api/firecrawl/analyze`)

**Входные данные:**
- URL сайта дома престарелых
- Название дома престарелых (опционально)

**Процесс:**

1. **Валидация и подготовка:**
   - Проверка наличия API ключа Firecrawl в конфигурации
   - Нормализация URL (добавление протокола https:// если отсутствует)

2. **Извлечение структурированных данных:**
   - Используется метод `analyze_care_home_website` из `FirecrawlAPIClient`
   - Приоритетный метод: Firecrawl Extract API с JSON-схемой для структурированного извлечения
   - Fallback метод: парсинг через `scrape_url` с последующим извлечением через регулярные выражения

3. **Извлекаемые данные:**
   - Название дома престарелых
   - Квалификация персонала (RGN, NVQ, сертификаты)
   - Удобства (сад, бассейн, спортзал, кинотеатр, салон и т.д.)
   - Услуги по уходу (деменция, сестринский уход, временный уход и т.д.)
   - Информация о ценах
   - Программы деятельности
   - Контактная информация (телефон, email, адрес)

**Выходные данные:**
```json
{
  "status": "success",
  "data": {
    "care_home_name": "...",
    "website_url": "...",
    "structured_data": {
      "staff_qualifications": [...],
      "facilities": [...],
      "services": [...],
      "pricing_info": "...",
      "activities": [...],
      "contact_info": {...}
    },
    "extraction_method": "llm-extraction" | "scrape-and-parse"
  }
}
```

**Ссылка на реализацию:**
- Endpoint: `main.py`, строки 2565-2602
- Клиент: `api_clients/firecrawl_client.py`, строки 246-367

#### 2.2.2 Комплексный анализ (`/api/firecrawl/unified-analysis`)

**Входные данные:**
- URL сайта дома престарелых
- Название дома престарелых
- Адрес, город, почтовый индекс

**Процесс:**

1. **Шаг 1: Анализ сайта через Firecrawl**
   - Вызов `analyze_care_home_website` для получения структурированных данных со сайта
   - Извлечение информации о персонале, услугах, удобствах, ценах

2. **Шаг 2: Интеграция с Google Places API** (если настроен API ключ)
   - Поиск места в Google Places по нескольким вариантам запросов:
     - Название + почтовый индекс
     - Название + город + почтовый индекс
     - Название + город
     - Полный запрос с "care home"
   - Использование `find_place` API, при неудаче — `text_search` API
   - Получение деталей места: рейтинг, количество отзывов, отзывы, адрес, телефон, сайт
   - Получение insights (популярные времена посещения, анализ отзывов)

3. **Шаг 3: Объединение данных**
   - Создание единого объекта с данными из обоих источников
   - Указание источников данных и метки времени анализа

**Выходные данные:**
```json
{
  "status": "success",
  "data": {
    "care_home_name": "...",
    "website_url": "...",
    "address": "...",
    "firecrawl_analysis": {...},
    "google_places_data": {
      "place_details": {...},
      "insights": {...}
    },
    "data_sources": {
      "firecrawl": true,
      "google_places": true
    },
    "analysis_timestamp": "..."
  }
}
```

**Ссылка на реализацию:**
- Endpoint: `main.py`, строки 2735-2926
- Логика поиска Google Places: `main.py`, строки 2772-2896

#### 2.2.3 Методы извлечения данных

**Метод 1: LLM Extraction (приоритетный)**
- Использует Firecrawl Extract API с JSON-схемой
- AI-модель извлекает структурированные данные из контента сайта
- Более точное извлечение семантической информации

**Метод 2: Scrape and Parse (fallback)**
- Парсинг страницы через `scrape_url` в формате markdown
- Извлечение данных через регулярные выражения и ключевые слова:
  - Квалификации персонала: поиск по ключевым словам (RGN, NVQ, certificate, qualified, registered nurse)
  - Удобства: поиск по ключевым словам (garden, pool, gym, cinema, salon, library, therapy)
  - Услуги: поиск по ключевым словам (dementia, nursing, residential, respite, palliative)
  - Цены: регулярные выражения для паттернов цен (£X,XXX/week, from £X,XXX)
  - Контакты: регулярные выражения для телефонов и email

**Ссылка на реализацию:**
- Extract метод: `api_clients/firecrawl_client.py`, строки 171-211
- Analyze метод: `api_clients/firecrawl_client.py`, строки 246-367
- Парсинг методы: `api_clients/firecrawl_client.py`, строки 369-501

### 2.3 Обработка ошибок

**Стратегия обработки:**
1. Проверка наличия API ключей перед выполнением запросов
2. Нормализация URL (добавление протокола)
3. Fallback механизмы:
   - При ошибке Extract API → переход на Scrape and Parse
   - При ошибке Google Places → продолжение только с Firecrawl данными
4. Детальное логирование ошибок с контекстом

**Ссылка на реализацию:**
- Обработка ошибок: `main.py`, строки 2595-2602, 2738-2926
- Обработка в клиенте: `api_clients/firecrawl_client.py`, строки 47-57, 107-117, 159-169, 201-211

### 2.4 Конфигурация

**Хранение API ключей:**
- API ключи хранятся в конфигурационном файле
- Загрузка через `get_credentials()` из `config_manager`
- Проверка наличия ключей перед выполнением запросов

**Ссылка на реализацию:**
- Загрузка credentials: `main.py`, строки 2574, 2740
- Проверка конфигурации: `main.py`, строки 2575-2580, 2743-2748

---

## 3. Критерии валидации для аналитика

### 3.1 Функциональная валидация

1. **Проверка извлечения данных:**
   - Убедиться, что извлекаются все ключевые поля (квалификация персонала, удобства, услуги, цены, деятельность)
   - Проверить качество извлечения (точность, полнота)
   - Сравнить результаты LLM Extraction vs Scrape and Parse

2. **Проверка интеграции с Google Places:**
   - Убедиться, что поиск работает с разными вариантами запросов
   - Проверить корректность объединения данных из Firecrawl и Google Places
   - Проверить обработку случаев, когда Google Places API недоступен

3. **Проверка обработки ошибок:**
   - Протестировать сценарии с невалидными URL
   - Протестировать сценарии с отсутствующими API ключами
   - Протестировать сценарии с недоступными сайтами

### 3.2 Сравнение с Autumna

1. **Полнота данных:**
   - Сравнить количество полей данных: Autumna (8-12) vs Firecrawl (50-100+)
   - Проверить наличие данных, отсутствующих в Autumna (квалификация персонала, детальные услуги, программы деятельности)

2. **Актуальность данных:**
   - Проверить дату последнего обновления данных
   - Сравнить информацию о ценах между Autumna и сайтом дома престарелых

3. **Качество данных:**
   - Проверить точность извлечённых данных на выборке домов престарелых
   - Сравнить контактную информацию (телефон, адрес) между источниками

### 3.3 Производительность и стоимость

1. **Время выполнения:**
   - Измерить время выполнения анализа одного сайта
   - Измерить время выполнения комплексного анализа (Firecrawl + Google Places)

2. **Стоимость:**
   - Оценить стоимость парсинга одного дома престарелых через Firecrawl
   - Сравнить с текущей стоимостью ручного труда для Autumna парсинга

### 3.4 Рекомендации по улучшению

На основе валидации предоставить рекомендации по:
- Улучшению точности извлечения данных
- Оптимизации производительности
- Расширению функциональности
- Снижению стоимости

---

## 4. Файлы для валидации

**Основные файлы реализации:**

1. **API Endpoints:**
   - `api-testing-suite/backend/main.py` (строки 2565-2926)

2. **Firecrawl Client:**
   - `api-testing-suite/backend/api_clients/firecrawl_client.py` (полный файл)

3. **Модели данных:**
   - `api-testing-suite/backend/models/schemas.py` (модели `FirecrawlAnalyzeRequest`, `FirecrawlUnifiedAnalysisRequest`)

4. **Конфигурация:**
   - `api-testing-suite/backend/config_manager.py` (загрузка API ключей)

**Документация:**
- Стратегия внедрения: `RightCareHome-Firecrawl-Implementation-Strategy-Full-RU.md`

---

## 5. Примеры использования для тестирования

### 5.1 Базовый анализ сайта

**Endpoint:** `POST /api/firecrawl/analyze`

**Request:**
```json
{
  "url": "https://www.manorhousecare.co.uk",
  "care_home_name": "Manor House Care Home"
}
```

**Ожидаемый результат:**
- Структурированные данные о доме престарелых
- Информация о персонале, услугах, удобствах, ценах

### 5.2 Комплексный анализ

**Endpoint:** `POST /api/firecrawl/unified-analysis`

**Request:**
```json
{
  "website_url": "https://www.manorhousecare.co.uk",
  "care_home_name": "Manor House Care Home",
  "address": "123 High Street",
  "city": "Birmingham",
  "postcode": "B10 2PE"
}
```

**Ожидаемый результат:**
- Данные из Firecrawl (анализ сайта)
- Данные из Google Places (рейтинг, отзывы, популярность)
- Объединённый профиль дома престарелых

---

**Дата создания:** 2025-01-27  
**Версия:** 1.0  
**Статус:** Готово к валидации

