# –≠—Ç–∞–ø 2: –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–æ–¥—É–ª–µ–π - –ó–ê–í–ï–†–®–ï–ù ‚úÖ

**–î–∞—Ç–∞:** 2025-01-XX  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù

---

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –û–±–Ω–æ–≤–ª–µ–Ω `services/csv_care_homes_service.py` ‚úÖ

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**

1. **–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `get_care_homes_hybrid()`**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (CQC + Staging)
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ CQC CSV —á–µ—Ä–µ–∑ `cqc_data_loader.load_cqc_homes()`
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Staging CSV —á–µ—Ä–µ–∑ `staging_data_loader.load_staging_data()`
   - –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ `hybrid_data_merger.merge_cqc_and_staging()`
   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é (local_authority, care_type)
   - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç auto-expand —Ä–∞–¥–∏—É—Å

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_care_homes()`**
   - –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `use_hybrid: bool = True` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω)
   - –ü—Ä–æ–±—É–µ—Ç –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –ø–µ—Ä–≤—ã–º
   - Fallback –Ω–∞ legacy CSV –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
```python
def get_care_homes(..., use_hybrid=True):
    if use_hybrid:
        try:
            return get_care_homes_hybrid(...)  # –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ (CQC + Staging)
        except:
            # Fallback –Ω–∞ legacy CSV
            return load_csv_care_homes(...)  # –°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥
    else:
        return load_csv_care_homes(...)  # –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ legacy
```

**–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
- ‚úÖ –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã `get_care_homes()` —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- ‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ legacy CSV
- ‚úÖ –ú–æ–∂–Ω–æ —è–≤–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —á–µ—Ä–µ–∑ `use_hybrid=False`

---

### 2. –û–±–Ω–æ–≤–ª–µ–Ω `routers/report_routes.py` ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–û–±–Ω–æ–≤–ª–µ–Ω –æ—Å–Ω–æ–≤–Ω–æ–π –≤—ã–∑–æ–≤ `get_csv_care_homes()`**
   - –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `use_hybrid=True` –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –≤—ã–∑–æ–≤
   - –î–æ–±–∞–≤–ª–µ–Ω fallback –Ω–∞ legacy CSV –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

2. **–û–±–Ω–æ–≤–ª–µ–Ω –≤—ã–∑–æ–≤ –ø—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞**
   - –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `use_hybrid=True` –≤ –≤—ã–∑–æ–≤ –ø—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ —Ä–∞–¥–∏—É—Å–∞
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞

**–î–æ:**
```python
care_homes = await asyncio.to_thread(
    get_csv_care_homes,
    local_authority=...,
    care_type=...,
    max_distance_km=...,
    user_lat=...,
    user_lon=...,
    limit=initial_limit
)
```

**–ü–æ—Å–ª–µ:**
```python
care_homes = await asyncio.to_thread(
    get_csv_care_homes,
    local_authority=...,
    care_type=...,
    max_distance_km=...,
    user_lat=...,
    user_lon=...,
    limit=initial_limit,
    use_hybrid=True  # ‚Üê –ù–û–í–û–ï: –≤–∫–ª—é—á–µ–Ω –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥
)
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ legacy CSV
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ fallback –Ω–∞ AsyncDataLoader

---

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:**

1. ‚úÖ **–ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª–µ–π:** –í—Å–µ –º–æ–¥—É–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
2. ‚úÖ **–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥:** `get_care_homes_hybrid()` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ó–∞–≥—Ä—É–∂–µ–Ω–æ 5 –¥–æ–º–æ–≤ –∏–∑ CQC CSV
   - –í—Å–µ –¥–æ–º–∞ –∏–º–µ—é—Ç CQC –ø–æ–ª—è (serves_older_people, –∏ —Ç.–¥.)
   - Staging –ø–æ–ª—è –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è (0 –∑–∞–ø–∏—Å–µ–π –≤ Staging CSV - –≤–æ–∑–º–æ–∂–Ω–æ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω)
3. ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** `get_care_homes(use_hybrid=True)` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥
4. ‚úÖ **Fallback:** `get_care_homes(use_hybrid=False)` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç legacy CSV (1,648 –¥–æ–º–æ–≤)
5. ‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã —Ä–∞–±–æ—Ç–∞—é—Ç

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
‚úÖ Modules imported successfully

üìã Testing hybrid approach:
  ‚úÖ Hybrid approach: 5 homes
  First home: Henley House
  Location ID: 1-10000302982
  Has CQC fields: True
  Has Staging fields: False

üìã Testing get_care_homes (hybrid=True):
  ‚úÖ get_care_homes (hybrid): 5 homes

üìã Testing get_care_homes (hybrid=False - legacy):
  ‚úÖ Loaded 1648 care homes from CSV
  ‚úÖ get_care_homes (legacy): 5 homes

‚úÖ All integration tests passed!
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `services/csv_care_homes_service.py`: +150 —Å—Ç—Ä–æ–∫ (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `get_care_homes_hybrid()`)
- `routers/report_routes.py`: +30 —Å—Ç—Ä–æ–∫ (–æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤—ã–∑–æ–≤—ã —Å `use_hybrid=True`)

**–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (CQC + Staging) –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ legacy CSV
- ‚úÖ –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

**–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- ‚úÖ CQC: 14,599 –¥–æ–º–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
- ‚ö†Ô∏è Staging: 0 –∑–∞–ø–∏—Å–µ–π (—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç–æ–π - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, fallback —Ä–∞–±–æ—Ç–∞–µ—Ç)

---

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

**–≠—Ç–∞–ø 3:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –º–∞—Ç—á–∏–Ω–≥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∞–ª–≥–æ—Ä–∏—Ç–º –º–∞—Ç—á–∏–Ω–≥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–æ–ª—è –∏–∑ Staging (Pricing, Reviews, Amenities)
- **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ê–ª–≥–æ—Ä–∏—Ç–º –º–∞—Ç—á–∏–Ω–≥–∞ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏, —Ç–∞–∫ –∫–∞–∫ –ø–æ–ª—É—á–∞–µ—Ç –∏—Ö –∏–∑ `get_care_homes()`

**–≠—Ç–∞–ø 4:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- Unit —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- Integration —Ç–µ—Å—Ç—ã –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
- End-to-end —Ç–µ—Å—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞

---

## ‚ö†Ô∏è –ó–∞–º–µ—á–∞–Ω–∏—è

1. **Staging CSV:** –ü–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è (0 –∑–∞–ø–∏—Å–µ–π). –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
   - –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º –ø—É—Ç—è–º
   - –§–∞–π–ª –ø—É—Å—Ç–æ–π
   - –≠—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å CQC –¥–∞–Ω–Ω—ã–º–∏ –∏ –∏–º–µ–µ—Ç fallback –Ω–∞ legacy CSV

2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
   - –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - Fallback –Ω–∞ legacy CSV —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –≠–¢–ê–ü 2 –ó–ê–í–ï–†–®–ï–ù
