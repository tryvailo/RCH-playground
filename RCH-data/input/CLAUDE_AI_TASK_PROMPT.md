# ЗАДАЧА ДЛЯ CLAUDE AI: Исправление маппинга данных CQC

## КОНТЕКСТ

Имеется процесс маппинга данных из исходной базы данных CQC (`cqc_dataset_test_initalDB.csv`) в целевую структуру базы данных версии 2.2 (`care_homes_rows_after_mapping.csv`).

**Исходный файл:** `cqc_dataset_test_initalDB.csv` (129 полей, 271 запись)
**Итоговый файл:** `care_homes_rows_after_mapping.csv` (93 поля, 271 запись)

## ПРОБЛЕМА

При анализе результатов маппинга обнаружены **критические пропуски** - поля, которые были заполнены в исходной базе данных, но не были замаплены в итоговую базу данных, в результате чего они остались пустыми.

## КРИТИЧЕСКИЕ ПРОПУСКИ В МАППИНГЕ

### 1. `publication_date` → `cqc_publication_date`

- **Исходное поле:** `publication_date` (заполнено в 248 записях из 271 = 91.5%)
- **Целевое поле:** `cqc_publication_date` (в итоговой базе пусто)
- **Формат данных в исходнике:** Дата в формате `DD/MM/YYYY` или `D/M/YY` (например: `26/04/2022`, `1/10/20`, `20/01/2023`)
- **Требование:** Преобразовать даты в стандартный формат ISO (YYYY-MM-DD) или сохранить исходный формат, если он соответствует требованиям целевой БД

### 2. `location_hsca_start_date` → `year_opened`

- **Исходное поле:** `location_hsca_start_date` (заполнено в 271 записи = 100%)
- **Целевое поле:** `year_opened` (в итоговой базе пусто)
- **Формат данных в исходнике:** Дата в формате `DD/MM/YYYY` (например: `14/12/2020`, `16/12/2013`, `20/05/2021`)
- **Требование:** Извлечь год из даты и заполнить поле `year_opened` (целое число, например: `2020`, `2013`, `2021`)

## ДОПОЛНИТЕЛЬНАЯ ПРОБЛЕМА: Логика маппинга лицензий

### 3. `has_nursing_care_license` (требует проверки логики)

**Текущая ситуация:**
- В исходнике: `service_type_care_home_service_with_nursing = TRUE` для 73 домов
- В исходнике: `regulated_activity_nursing_care = TRUE` для **0 домов** (все FALSE!)
- В итоговой базе: `care_nursing = TRUE` для 73 домов
- В итоговой базе: `has_nursing_care_license = FALSE` для **всех 73 домов**

**Наблюдение:**
- `regulated_activity_nursing_care` в исходнике **всегда FALSE**, даже для домов с nursing care
- Это может означать, что `regulated_activity_nursing_care` не означает наличие лицензии на nursing care

**Требование:** 
- Проверить логику маппинга `has_nursing_care_license`
- Возможно, нужно использовать `service_type_care_home_service_with_nursing = TRUE` для определения `has_nursing_care_license = TRUE`
- Или проверить другие поля `regulated_activity_*` для определения лицензий

## ЗАДАЧА

Необходимо **исправить скрипт/логику маппинга**, чтобы:

1. ✅ Добавить маппинг `publication_date` → `cqc_publication_date`
   - Преобразовать даты из формата `DD/MM/YYYY` или `D/M/YY` в стандартный формат
   - Обработать случаи с неполными датами (например, `1/10/20` → `2020-10-01`)
   - Обработать пустые значения (23 записи не имеют даты)

2. ✅ Добавить маппинг `location_hsca_start_date` → `year_opened`
   - Извлечь год из даты формата `DD/MM/YYYY`
   - Сохранить как целое число (год)
   - Все 271 запись имеют это поле заполненным

3. ✅ Проверить и исправить логику маппинга `has_nursing_care_license`
   - Определить корректное поле/поля для определения наличия лицензии на nursing care
   - Убедиться, что дома с `care_nursing = TRUE` имеют корректное значение `has_nursing_care_license`

## ВХОДНЫЕ ДАННЫЕ

Прикреплен файл: `cqc_dataset_test_initalDB.csv`

**Структура исходного файла:**
- 129 колонок
- 271 запись
- Формат: CSV с заголовками
- Кодировка: UTF-8

**Важные поля для задачи:**
- `publication_date` - дата публикации CQC отчета (формат: DD/MM/YYYY или D/M/YY)
- `location_hsca_start_date` - дата начала регистрации (формат: DD/MM/YYYY)
- `service_type_care_home_service_with_nursing` - булево поле (TRUE/FALSE)
- `regulated_activity_nursing_care` - булево поле (TRUE/FALSE)
- Все остальные `regulated_activity_*` поля для проверки логики лицензий

## ОЖИДАЕМЫЙ РЕЗУЛЬТАТ

После исправления маппинга в итоговой базе данных должны быть заполнены:

1. **`cqc_publication_date`**: ~248 записей (91.5%) с корректно отформатированными датами
2. **`year_opened`**: 271 запись (100%) с годами, извлеченными из `location_hsca_start_date`
3. **`has_nursing_care_license`**: Правильные значения для всех домов с nursing care

## ДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ

- Целевая структура БД: `care_homes_db_v2_2.sql` (если требуется для понимания типов данных)
- Текущий результат маппинга: `care_homes_rows_after_mapping.csv` (для сравнения)
- Отчет о проблемах: `MAPPING_COMPARISON_REPORT.md` (детальный анализ)

## ТРЕБОВАНИЯ К РЕШЕНИЮ

1. **Код должен быть:**
   - Читаемым и комментированным
   - Обрабатывать краевые случаи (пустые значения, разные форматы дат)
   - Сохранять существующую логику маппинга для других полей

2. **Проверка результата:**
   - Убедиться, что все даты корректно преобразованы
   - Убедиться, что все годы извлечены корректно
   - Убедиться, что логика лицензий работает правильно

3. **Документация:**
   - Описать изменения в логике маппинга
   - Указать причины изменения логики лицензий (если требуется)

---

**ВАЖНО:** При работе с датами учитывать различные форматы в исходных данных и обеспечить корректное преобразование в целевой формат.

