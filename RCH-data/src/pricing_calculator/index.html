<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing Calculator - RightCareHome</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: -280px;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .sidebar-header h2 {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .sidebar-header p {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .sidebar-menu {
            padding: 16px 0;
        }
        
        .sidebar-menu-item {
            display: flex;
            align-items: center;
            padding: 14px 24px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }
        
        .sidebar-menu-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .sidebar-menu-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: white;
        }
        
        .sidebar-menu-item-icon {
            font-size: 20px;
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }
        
        .sidebar-menu-item-text {
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Menu Toggle Button */
        .menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .menu-toggle:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: scale(1.05);
        }
        
        .menu-toggle-icon {
            width: 24px;
            height: 24px;
            position: relative;
        }
        
        .menu-toggle-icon span {
            display: block;
            position: absolute;
            height: 2px;
            width: 100%;
            background: #667eea;
            border-radius: 2px;
            transition: all 0.3s;
        }
        
        .menu-toggle-icon span:nth-child(1) {
            top: 6px;
        }
        
        .menu-toggle-icon span:nth-child(2) {
            top: 12px;
        }
        
        .menu-toggle-icon span:nth-child(3) {
            top: 18px;
        }
        
        .menu-toggle.open .menu-toggle-icon span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .menu-toggle.open .menu-toggle-icon span:nth-child(2) {
            opacity: 0;
        }
        
        .menu-toggle.open .menu-toggle-icon span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }
        
        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 0;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        
        .main-content.sidebar-open {
            margin-left: 0;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 16px 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: #e9ecef;
            color: #333;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }
        
        /* Hide tabs completely - use sidebar menu only */
        .tabs {
            display: none !important;
        }
        
        .tab-content {
            display: none;
            padding: 24px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .savings-nav-btn {
            padding: 12px 24px;
            margin-right: 10px;
            border: none;
            background: #f0f0f0;
            color: #333;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .savings-nav-btn:hover {
            background: #e0e0e0;
        }
        
        .savings-nav-btn.active {
            background: #667eea;
            color: white;
        }
        
        .savings-tab-content {
            display: none;
        }
        
        .savings-tab-content.active {
            display: block;
        }
        
        .domain-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .domain-card h4 {
            margin-top: 0;
            color: #667eea;
            font-size: 16px;
        }
        
        .domain-card select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 8px;
        }
        
        .domain-card textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 8px;
            min-height: 60px;
            font-family: inherit;
        }
        
        .filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            padding: 16px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .stats {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
            white-space: nowrap;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .band {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
        }
        
        .band-A { background: #d4edda; color: #155724; }
        .band-B { background: #d1ecf1; color: #0c5460; }
        .band-C { background: #fff3cd; color: #856404; }
        .band-D { background: #f8d7da; color: #721c24; }
        .band-E { background: #f5c6cb; color: #721c24; }
        
        .price {
            font-weight: 600;
            color: #333;
        }
        
        .gap-positive {
            color: #dc3545;
        }
        
        .gap-negative {
            color: #28a745;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        
        .calculator-form {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5568d3;
        }
        
        .result-card {
            margin-top: 24px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #667eea;
        }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .result-row:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: 600;
            color: #666;
        }
        
        .result-value {
            color: #333;
            font-weight: 600;
        }
        
        .info-section {
            margin-bottom: 24px;
        }
        
        .info-section h3 {
            margin-bottom: 12px;
            color: #333;
        }
        
        .info-section p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 8px;
        }
        
        .code-block {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <!-- Sidebar Menu -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üè† RightCareHome</h2>
            <p>Navigation Menu</p>
        </div>
        <div class="sidebar-menu">
            <div class="sidebar-menu-item active" onclick="switchTabFromSidebar('locations')">
                <span class="sidebar-menu-item-icon">üìç</span>
                <span class="sidebar-menu-item-text">All Locations</span>
            </div>
            <div class="sidebar-menu-item" onclick="switchTabFromSidebar('calculator')">
                <span class="sidebar-menu-item-icon">üßÆ</span>
                <span class="sidebar-menu-item-text">Postcode Calculator</span>
            </div>
            <div class="sidebar-menu-item" onclick="switchTabFromSidebar('price_calculator')">
                <span class="sidebar-menu-item-icon">üí∞</span>
                <span class="sidebar-menu-item-text">Price Calculator</span>
            </div>
            <div class="sidebar-menu-item" onclick="switchTabFromSidebar('savings_calculator')">
                <span class="sidebar-menu-item-icon">üí∑</span>
                <span class="sidebar-menu-item-text">Savings Calculator</span>
            </div>
            <div class="sidebar-menu-item" onclick="switchTabFromSidebar('postcode_tester')">
                <span class="sidebar-menu-item-icon">üìç</span>
                <span class="sidebar-menu-item-text">Postcode Tester</span>
            </div>
            <div class="sidebar-menu-item" onclick="switchTabFromSidebar('data_admin')">
                <span class="sidebar-menu-item-icon">üìä</span>
                <span class="sidebar-menu-item-text">Data Admin</span>
            </div>
            <div class="sidebar-menu-item" onclick="switchTabFromSidebar('help')">
                <span class="sidebar-menu-item-icon">üìñ</span>
                <span class="sidebar-menu-item-text">Help & Guide</span>
            </div>
            <div class="sidebar-menu-item" onclick="switchTabFromSidebar('about')">
                <span class="sidebar-menu-item-icon">‚ÑπÔ∏è</span>
                <span class="sidebar-menu-item-text">About</span>
            </div>
        </div>
    </div>
    
    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    
    <!-- Menu Toggle Button -->
    <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()">
        <div class="menu-toggle-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </button>
    
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <div class="header">
                <h1>üè† RightCareHome</h1>
                <p>UK Care Homes Pricing & Affordability Analysis</p>
            </div>
        
        <!-- Tab 1: All Locations -->
        <div id="locations" class="tab-content active">
            <h2>All Locations Pricing Table</h2>
            
            <div id="error" class="error" style="display: none;"></div>
            
            <div class="filters">
                <div class="filter-group">
                    <label>Care Type</label>
                    <select id="careType">
                        <option value="">All</option>
                        <option value="residential">Residential</option>
                        <option value="nursing">Nursing</option>
                        <option value="residential_dementia">Residential Dementia</option>
                        <option value="nursing_dementia">Nursing Dementia</option>
                        <option value="respite">Respite</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Region</label>
                    <select id="region">
                        <option value="">All</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Affordability Band</label>
                    <select id="band">
                        <option value="">All</option>
                        <option value="A">A - Excellent</option>
                        <option value="B">B - Good</option>
                        <option value="C">C - Fair</option>
                        <option value="D">D - Premium</option>
                        <option value="E">E - Very Expensive</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Min Fair Cost (¬£/week)</label>
                    <input type="number" id="minFairCost" placeholder="Min">
                </div>
                
                <div class="filter-group">
                    <label>Max Fair Cost (¬£/week)</label>
                    <input type="number" id="maxFairCost" placeholder="Max">
                </div>
            </div>
            
            <div class="stats" id="stats" style="display: none;">
                <div class="stat">
                    <span class="stat-value" id="totalLocations">0</span>
                    <span class="stat-label">Total Locations</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="avgFairCost">¬£0</span>
                    <span class="stat-label">Avg Fair Cost</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="avgPrivate">¬£0</span>
                    <span class="stat-label">Avg Private</span>
                </div>
            </div>
            
            <div class="table-container">
                <div id="loading" class="loading">Loading data...</div>
                <table id="pricingTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Local Authority</th>
                            <th>Region</th>
                            <th>Care Type</th>
                            <th>Fair Cost (¬£/week)</th>
                            <th>Private Avg (¬£/week)</th>
                            <th>Gap</th>
                            <th>Gap %</th>
                            <th>Band</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab 2: Postcode Calculator -->
        <div id="calculator" class="tab-content">
            <h2>Postcode Pricing Calculator</h2>
            
            <div class="calculator-form">
                <div class="form-group">
                    <label>Postcode</label>
                    <input type="text" id="postcodeInput" placeholder="e.g., B15 2HQ" value="B15 2HQ">
                </div>
                
                <div class="form-group">
                    <label>Care Type</label>
                    <select id="calcCareType">
                        <option value="residential">Residential</option>
                        <option value="nursing">Nursing</option>
                        <option value="residential_dementia">Residential Dementia</option>
                        <option value="nursing_dementia">Nursing Dementia</option>
                        <option value="respite">Respite</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>CQC Rating (Optional)</label>
                    <select id="cqcRating">
                        <option value="">None</option>
                        <option value="Outstanding">Outstanding</option>
                        <option value="Good">Good</option>
                        <option value="Requires Improvement">Requires Improvement</option>
                        <option value="Inadequate">Inadequate</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Facilities Score (0-20, Optional)</label>
                    <input type="number" id="facilitiesScore" min="0" max="20" placeholder="0-20">
                </div>
                
                <div class="form-group">
                    <label>Bed Count (Optional)</label>
                    <input type="number" id="bedCount" min="1" placeholder="Number of beds">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isChain"> Is part of a chain
                    </label>
                </div>
                
                <button class="btn" onclick="calculatePostcode()">Calculate Pricing</button>
                
                <div id="calcResult" style="display: none;"></div>
                <div id="calcError" class="error" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Tab: Price Calculator -->
        <div id="price_calculator" class="tab-content">
            <h2>üí∞ Price Calculator</h2>
            <p>Calculate pricing and Affordability Bands using Band v5 logic</p>
            
            <form id="priceCalculatorForm" onsubmit="calculatePrice(event)">
                <div class="filters">
                    <div class="filter-group">
                        <label>Postcode</label>
                        <input type="text" id="pricePostcode" placeholder="e.g., B15 2HQ" value="B15 2HQ" required>
                    </div>
                    
                    <div class="filter-group">
                        <label>Care Type</label>
                        <select id="priceCareType" required>
                            <option value="residential">Residential</option>
                            <option value="nursing">Nursing</option>
                            <option value="residential_dementia">Residential Dementia</option>
                            <option value="nursing_dementia">Nursing Dementia</option>
                            <option value="respite">Respite</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>CQC Rating (Optional)</label>
                        <select id="priceCqcRating">
                            <option value="">Not specified</option>
                            <option value="Outstanding">Outstanding</option>
                            <option value="Good">Good</option>
                            <option value="Requires Improvement">Requires Improvement</option>
                            <option value="Inadequate">Inadequate</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Facilities Score (0-20)</label>
                        <input type="number" id="priceFacilitiesScore" min="0" max="20" value="10">
                    </div>
                    
                    <div class="filter-group">
                        <label>Bed Count (Optional)</label>
                        <input type="number" id="priceBedCount" min="1" value="25">
                    </div>
                    
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="priceIsChain"> Is part of a chain
                        </label>
                    </div>
                    
                    <div class="filter-group">
                        <label>Scraped Price (Optional - Overrides Calculation)</label>
                        <input type="number" id="priceScrapedPrice" min="0" step="10" placeholder="Leave empty for calculation">
                    </div>
                </div>
                
                <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">Calculate Pricing</button>
            </form>
            
            <div id="priceError" class="error" style="display: none; margin-top: 20px;"></div>
            
            <div id="priceResult" style="display: none; margin-top: 30px;">
                <!-- Results will be inserted here -->
            </div>
        </div>
        
        <!-- Tab: Savings Calculator -->
        <div id="savings_calculator" class="tab-content">
            <h2>üí∑ Funding Eligibility Calculator 2025-2026</h2>
            <p><strong>Advanced CHC & LA Funding Assessment Tool</strong></p>
            <p style="color: #666; font-size: 14px;">Based on NHS National Framework 2022 (current 2025), MSIF 2025-2026, Care Act 2014</p>
            
            <!-- Navigation Tabs -->
            <div style="margin: 30px 0; border-bottom: 2px solid #e0e0e0;">
                <button class="savings-nav-btn active" onclick="switchSavingsTab('domains')" id="savingsTabDomains">1Ô∏è‚É£ Domain Assessment</button>
                <button class="savings-nav-btn" onclick="switchSavingsTab('financial')" id="savingsTabFinancial">2Ô∏è‚É£ Financial Information</button>
                <button class="savings-nav-btn" onclick="switchSavingsTab('results')" id="savingsTabResults">3Ô∏è‚É£ Results</button>
            </div>
            
            <!-- Domain Assessment Tab -->
            <div id="savingsDomainsTab" class="savings-tab-content active">
                <h3>DST Domain Assessment (12 Domains)</h3>
                <p style="color: #666; margin-bottom: 20px;">Decision Support Tool 2025 - Assess each domain</p>
                
                <div id="domainAssessments" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                    <!-- Domains will be generated by JavaScript -->
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                    <h4>Additional Health Indicators</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <label><input type="checkbox" id="savingsPrimaryHealthNeed"> Has Primary Health Need</label>
                        <label><input type="checkbox" id="savingsRequiresNursingCare"> Requires Nursing Care</label>
                        <label><input type="checkbox" id="savingsPegFeeding"> PEG/PEJ/NJ Feeding</label>
                        <label><input type="checkbox" id="savingsTracheostomy"> Tracheostomy</label>
                        <label><input type="checkbox" id="savingsRequiresInjections"> Regular Injections</label>
                        <label><input type="checkbox" id="savingsRequiresVentilator"> Ventilator Support</label>
                        <label><input type="checkbox" id="savingsRequiresDialysis"> Dialysis</label>
                        <label><input type="checkbox" id="savingsUnpredictableNeeds"> Unpredictable Needs</label>
                        <label><input type="checkbox" id="savingsFluctuatingCondition"> Fluctuating Condition</label>
                        <label><input type="checkbox" id="savingsHighRiskBehaviours"> High Risk Behaviours</label>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 20px; background: #e7f3ff; border-radius: 8px;">
                    <h4>Patient Information</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div>
                            <label>Postcode (for pricing)</label>
                            <input type="text" id="savingsPostcode" placeholder="e.g., B15 2HQ" value="B15 2HQ" style="width: 100%; padding: 8px;">
                        </div>
                        <div>
                            <label>Age</label>
                            <input type="number" id="savingsAge" min="0" max="120" value="80" style="width: 100%; padding: 8px;">
                        </div>
                        <div>
                            <label>Care Type</label>
                            <select id="savingsCareType" style="width: 100%; padding: 8px;">
                                <option value="residential">Residential</option>
                                <option value="nursing">Nursing</option>
                                <option value="residential_dementia">Residential Dementia</option>
                                <option value="nursing_dementia">Nursing Dementia</option>
                                <option value="respite">Respite</option>
                            </select>
                        </div>
                        <div>
                            <label>
                                <input type="checkbox" id="savingsIsPermanentCare" checked> Permanent Care
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Financial Information Tab -->
            <div id="savingsFinancialTab" class="savings-tab-content" style="display: none;">
                <h3>Financial Information</h3>
                <p style="color: #666; margin-bottom: 20px;">Means Test 2025-2026 Assessment</p>
                
                <div style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; margin-bottom: 20px; border-radius: 4px;">
                    <strong>Capital Limits 2025-2026:</strong><br>
                    ‚Ä¢ Upper Limit: ¬£23,250 (fully self-funding)<br>
                    ‚Ä¢ Lower Limit: ¬£14,250 (fully funded)<br>
                    ‚Ä¢ Personal Expenses Allowance: ¬£28.25/week
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4>Capital Assets</h4>
                        <label>Capital Assets (excluding property) - GBP</label>
                        <input type="number" id="savingsCapitalAssets" min="0" value="0" step="1000" style="width: 100%; padding: 8px;">
                        
                        <label style="margin-top: 15px;">Weekly Income - GBP</label>
                        <input type="number" id="savingsWeeklyIncome" min="0" value="0" step="10" style="width: 100%; padding: 8px;">
                    </div>
                    
                    <div>
                        <h4>Property Details</h4>
                        <label>
                            <input type="checkbox" id="savingsHasProperty"> Has Property
                        </label>
                        
                        <div id="propertyDetails" style="display: none; margin-top: 15px;">
                            <label>Property Value - GBP</label>
                            <input type="number" id="savingsPropertyValue" min="0" value="0" step="10000" style="width: 100%; padding: 8px;">
                            
                            <label style="margin-top: 10px;">
                                <input type="checkbox" id="savingsIsMainResidence" checked> Is Main Residence
                            </label>
                            
                            <label style="margin-top: 10px;">
                                <input type="checkbox" id="savingsHasQualifyingRelative"> Has Qualifying Relative Living There
                            </label>
                            
                            <input type="text" id="savingsQualifyingRelativeDetails" placeholder="Qualifying Relative Details" style="width: 100%; padding: 8px; margin-top: 10px; display: none;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Tab -->
            <div id="savingsResultsTab" class="savings-tab-content" style="display: none;">
                <h3>Results & Recommendations</h3>
                
                <button class="btn" onclick="calculateFullSavings()" style="width: 100%; margin-bottom: 30px; padding: 15px; font-size: 16px;">üîÑ Calculate Funding Eligibility</button>
                
                <div id="savingsError" class="error" style="display: none; margin-top: 20px;"></div>
                
                <div id="savingsResult" style="display: none; margin-top: 30px;">
                    <!-- Results will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- Tab: Postcode Tester -->
        <div id="postcode_tester" class="tab-content">
            <h2>üìç Postcode Resolver Tester</h2>
            <p>Resolve UK postcodes to Local Authority and Region</p>
            
            <div style="margin-bottom: 30px;">
                <h3>Single Postcode Resolver</h3>
                <div class="filters">
                    <div class="filter-group" style="flex: 2;">
                        <label>Enter UK Postcode</label>
                        <input type="text" id="postcodeInput" placeholder="e.g., B15 2HQ, SW1A 1AA" value="B15 2HQ">
                    </div>
                    <div class="filter-group" style="flex: 1; display: flex; align-items: flex-end;">
                        <label>
                            <input type="checkbox" id="postcodeUseCache" checked> Use Cache
                        </label>
                    </div>
                </div>
                <button class="btn" onclick="resolveSinglePostcode()" style="width: 100%; margin-top: 10px;">Resolve Postcode</button>
                
                <div id="postcodeError" class="error" style="display: none; margin-top: 20px;"></div>
                <div id="postcodeResult" style="display: none; margin-top: 20px;"></div>
            </div>
            
            <div style="margin-top: 40px;">
                <h3>Batch Postcode Resolver</h3>
                <div class="filter-group">
                    <label>Enter Postcodes (one per line)</label>
                    <textarea id="batchPostcodes" rows="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">B15 2HQ
SW1A 1AA
M1 1AA
EH1 1YZ
CF10 3AT
BT1 5GS</textarea>
                </div>
                <div class="filters">
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="batchUseCache" checked> Use Cache
                        </label>
                    </div>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="batchValidate" checked> Validate Format
                        </label>
                    </div>
                </div>
                <button class="btn" onclick="resolveBatchPostcodes()" style="width: 100%; margin-top: 10px;">Resolve Batch</button>
                
                <div id="batchError" class="error" style="display: none; margin-top: 20px;"></div>
                <div id="batchResult" style="display: none; margin-top: 20px;"></div>
            </div>
        </div>
        
        <!-- Tab: Data Admin -->
        <div id="data_admin" class="tab-content">
            <h2>üìä Data Ingestion Admin</h2>
            <p>Manage MSIF and Lottie data updates</p>
            
            <div style="margin-bottom: 30px;">
                <button class="btn" onclick="initDatabase()" style="background: #6c757d; margin-bottom: 20px;">Initialize Database Tables</button>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h3>MSIF Data Refresh</h3>
                <div class="filters">
                    <div class="filter-group">
                        <button class="btn" onclick="refreshMSIF(2025)" style="width: 100%;">üîÑ Refresh MSIF 2025-2026</button>
                    </div>
                    <div class="filter-group">
                        <button class="btn" onclick="refreshMSIF(2024)" style="width: 100%; background: #6c757d;">üîÑ Refresh MSIF 2024-2025</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h3>Lottie Regional Averages</h3>
                <button class="btn" onclick="refreshLottie()" style="width: 100%;">üîÑ Refresh Lottie Data</button>
            </div>
            
            <div style="margin-top: 40px;">
                <h3>üìà Update Status</h3>
                <button class="btn" onclick="loadUpdateStatus()" style="background: #6c757d; margin-bottom: 20px;">üîÑ Refresh Status</button>
                
                <div id="updateStatusError" class="error" style="display: none; margin-top: 20px;"></div>
                <div id="updateStatusResult" style="display: none; margin-top: 20px;"></div>
            </div>
        </div>
        
        <!-- Tab: Help & Guide -->
        <div id="help" class="tab-content">
            <h2>üìñ Help & User Guide</h2>
            <p>Complete guide to using RightCareHome modules</p>
            
            <div style="margin-bottom: 40px;">
                <h3>üìç All Locations</h3>
                <div class="info-section">
                    <h4>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</h4>
                    <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ü–µ–Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö –ª–æ–∫–∞—Ü–∏–π (Local Authorities) –≤ –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏–∏. –¢–∞–±–ª–∏—Ü–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç Affordability Bands (A-E) –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —É—Ö–æ–¥–∞.</p>
                    
                    <h4>–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:</strong> –ü–æ —Ç–∏–ø—É —É—Ö–æ–¥–∞ (Care Type), —Ä–µ–≥–∏–æ–Ω—É (Region), Affordability Band</li>
                        <li><strong>–¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö:</strong> –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ Local Authority, Region, Care Type, Fair Cost, Private Average, Band, Confidence</li>
                        <li><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–∫–∞—Ü–∏–π, —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è Fair Cost –∏ Private Average</li>
                        <li><strong>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</strong> –ö–ª–∏–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</li>
                    </ul>
                    
                    <h4>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</h4>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—Ö–æ–¥–∞ –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ "Care Type" (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ "All")</li>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞ "Region" (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ "All")</li>
                        <li>–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤—ã–±–µ—Ä–∏—Ç–µ Affordability Band –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</li>
                        <li>–¢–∞–±–ª–∏—Ü–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è —Å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏</li>
                        <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</li>
                    </ol>
                </div>
            </div>
            
            <div style="margin-bottom: 40px;">
                <h3>üßÆ Postcode Calculator</h3>
                <div class="info-section">
                    <h4>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</h4>
                    <p>–ë—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á–µ—Ç —Ü–µ–Ω –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ UK postcode —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞ —É—Ö–æ–¥–∞ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.</p>
                    
                    <h4>–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö:</strong> Postcode, Care Type, CQC Rating (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</li>
                        <li><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</strong> Final Price, MSIF Lower Bound, Base Price, Expected Range</li>
                        <li><strong>Affordability Band:</strong> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç Band A-E</li>
                        <li><strong>–î–µ—Ç–∞–ª–∏:</strong> –ü–æ–∫–∞–∑ –≤—Å–µ—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã—Ö –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫</li>
                    </ul>
                    
                    <h4>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</h4>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>–í–≤–µ–¥–∏—Ç–µ UK postcode (–Ω–∞–ø—Ä–∏–º–µ—Ä, "B15 2HQ")</li>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—Ö–æ–¥–∞ –∏–∑ —Å–ø–∏—Å–∫–∞</li>
                        <li>–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ CQC Rating</li>
                        <li>–ù–∞–∂–º–∏—Ç–µ "Calculate Pricing"</li>
                        <li>–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: —Ü–µ–Ω—É, Band, –∏ –¥–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞</li>
                    </ol>
                </div>
            </div>
            
            <div style="margin-bottom: 40px;">
                <h3>üí∞ Price Calculator</h3>
                <div class="info-section">
                    <h4>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</h4>
                    <p>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ü–µ–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ª–æ–≥–∏–∫–∏ Band v5. –£—á–∏—Ç—ã–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ Affordability Band.</p>
                    
                    <h4>–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á–µ—Ç–∞:</strong> Postcode, Care Type, CQC Rating, Facilities Score (0-20), Bed Count, Is Chain</li>
                        <li><strong>Scraped Price Override:</strong> –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤–º–µ—Å—Ç–æ —Ä–∞—Å—á–µ—Ç–∞</li>
                        <li><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</strong> Final Price, MSIF Lower Bound, Base Price, Expected Range</li>
                        <li><strong>Affordability Band:</strong> Band A-E —Å Band Score –∏ Confidence meter</li>
                        <li><strong>Adjustments:</strong> –¢–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã—Ö –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ (CQC, Nursing, Dementia, Facilities, Size, Chain)</li>
                        <li><strong>Gap Analysis:</strong> Fair Cost Gap –≤ ¬£ –∏ %</li>
                        <li><strong>Negotiation Leverage Text:</strong> –ì–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤</li>
                        <li><strong>Save as Scraped Price:</strong> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è –±—É–¥—É—â–∏—Ö —Ä–∞—Å—á–µ—Ç–æ–≤</li>
                    </ul>
                    
                    <h4>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</h4>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: Postcode –∏ Care Type</li>
                        <li>–£–∫–∞–∂–∏—Ç–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>CQC Rating (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–µ–Ω)</li>
                                <li>Facilities Score –æ—Ç 0 (–±–∞–∑–æ–≤—ã–π) –¥–æ 20 (–æ—Ç–ª–∏—á–Ω—ã–π)</li>
                                <li>Bed Count (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç)</li>
                                <li>Is Chain (–µ—Å–ª–∏ –¥–æ–º –ø—Ä–µ—Å—Ç–∞—Ä–µ–ª—ã—Ö –≤—Ö–æ–¥–∏—Ç –≤ —Å–µ—Ç—å)</li>
                            </ul>
                        </li>
                        <li>–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ Scraped Price –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞</li>
                        <li>–ù–∞–∂–º–∏—Ç–µ "Calculate Pricing"</li>
                        <li>–ò–∑—É—á–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>Final Price - –∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –≤ –Ω–µ–¥–µ–ª—é</li>
                                <li>Affordability Band - Band A-E —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º</li>
                                <li>Confidence - —É—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ —Ä–∞—Å—á–µ—Ç–µ</li>
                                <li>Adjustments - –≤—Å–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</li>
                            </ul>
                        </li>
                        <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "Save as Scraped Price" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</li>
                    </ol>
                    
                    <h4>–õ–æ–≥–∏–∫–∞ Band v5</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>Base Price:</strong> Lottie 2025 regional average</li>
                        <li><strong>Lower Bound:</strong> MSIF 2025 median fee</li>
                        <li><strong>–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏:</strong>
                            <ul style="margin-left: 20px;">
                                <li>CQC Rating: Outstanding (+15%), Good (+5%), Requires Improvement (-5%), Inadequate (-15%)</li>
                                <li>Nursing: +25%</li>
                                <li>Dementia: +12%</li>
                                <li>Facilities Score: -10% –¥–æ +10% (–ª–∏–Ω–µ–π–Ω–æ –æ—Ç 0 –¥–æ 20)</li>
                                <li>Size: Small (&lt;20 beds) +5%, Large (&gt;60 beds) -5%</li>
                                <li>Chain: -8%</li>
                            </ul>
                        </li>
                        <li><strong>Band Score:</strong> (final_price - MSIF_lower) / (Lottie_average - MSIF_lower)</li>
                        <li><strong>Confidence:</strong> –í–∞–ª–∏–¥–∞—Ü–∏—è —Å MSIF –¥–∞–Ω–Ω—ã–º–∏</li>
                    </ul>
                </div>
            </div>
            
            <div style="margin-bottom: 40px;">
                <h3>üí∑ Savings Calculator</h3>
                <div class="info-section">
                    <h4>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</h4>
                    <p>–†–∞—Å—á–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∏ –∏ –æ—Ü–µ–Ω–∫–∏ –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ (CHC, Local Authority funding). –ü–æ–º–æ–≥–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–Ω–∏–∂–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ —É—Ö–æ–¥.</p>
                    
                    <h4>–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>Quick Assessment:</strong> 7 –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –ø–∞—Ü–∏–µ–Ω—Ç–µ</li>
                        <li><strong>Fair Cost Gap:</strong> –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç—å—é –∏ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç—å—é (–Ω–µ–¥–µ–ª—è/–≥–æ–¥/5 –ª–µ—Ç)</li>
                        <li><strong>Potential Savings:</strong> –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ</li>
                        <li><strong>CHC Eligibility:</strong> –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ Continuing Healthcare (CHC) —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ</li>
                        <li><strong>LA Funding:</strong> –û—Ü–µ–Ω–∫–∞ –ø—Ä–∞–≤–∞ –Ω–∞ Local Authority top-up –∏ Deferred Payment</li>
                        <li><strong>Recommendations:</strong> –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</li>
                        <li><strong>Full Report:</strong> –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –∑–∞ ¬£119</li>
                    </ul>
                    
                    <h4>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</h4>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li><strong>1Ô∏è‚É£ Postcode:</strong> Postcode –¥–æ–º–∞ –ø—Ä–µ—Å—Ç–∞—Ä–µ–ª—ã—Ö</li>
                                <li><strong>2Ô∏è‚É£ Care Type:</strong> –¢–∏–ø —Ç—Ä–µ–±—É–µ–º–æ–≥–æ —É—Ö–æ–¥–∞</li>
                                <li><strong>3Ô∏è‚É£ Patient Age:</strong> –í–æ–∑—Ä–∞—Å—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞</li>
                            </ul>
                        </li>
                        <li>–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –∑–¥–æ—Ä–æ–≤—å–µ:
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li><strong>4Ô∏è‚É£ Has Primary Health Need:</strong> –ï—Å—Ç—å –ª–∏ –æ—Å–Ω–æ–≤–Ω–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –∑–¥–æ—Ä–æ–≤—å–µ</li>
                                <li><strong>5Ô∏è‚É£ Health Conditions:</strong> –û—Ç–º–µ—Ç—å—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (Dementia, Parkinson's, Nursing Care)</li>
                                <li><strong>6Ô∏è‚É£ Mobility Level:</strong> –£—Ä–æ–≤–µ–Ω—å –º–æ–±–∏–ª—å–Ω–æ—Å—Ç–∏ (Independent, Assisted, Wheelchair, Bedbound)</li>
                                <li><strong>7Ô∏è‚É£ Capital Assets:</strong> –ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤—ã –≤ ¬£</li>
                            </ul>
                        </li>
                        <li>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>Weekly Income</li>
                                <li>Current Care Cost per Week</li>
                            </ul>
                        </li>
                        <li>–ù–∞–∂–º–∏—Ç–µ "Calculate Savings"</li>
                        <li>–ò–∑—É—á–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li><strong>Fair Cost Gap:</strong> –ö—Ä–∞—Å–Ω—ã–π –±–ª–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É –≤ —Å—Ç–æ–∏–º–æ—Å—Ç–∏</li>
                                <li><strong>Potential Savings:</strong> –ó–µ–ª–µ–Ω—ã–π –±–ª–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é —ç–∫–æ–Ω–æ–º–∏—é</li>
                                <li><strong>CHC Eligibility:</strong> –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏ —Ñ–∞–∫—Ç–æ—Ä—ã –ø—Ä–∞–≤–∞ –Ω–∞ CHC</li>
                                <li><strong>LA Funding:</strong> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Local Authority —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–∏</li>
                                <li><strong>Recommendations:</strong> –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</li>
                            </ul>
                        </li>
                        <li>–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –Ω–∞–∂–º–∏—Ç–µ "Get Full Report - ¬£119"</li>
                    </ol>
                    
                    <h4>–õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>CHC Probability:</strong> –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ Primary Health Need, —Å–ª–æ–∂–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –∑–¥–æ—Ä–æ–≤—å—è, –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ —É—Ö–æ–¥–µ</li>
                        <li><strong>LA Top-up:</strong> –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–∞–ø–∏—Ç–∞–ª—å–Ω—ã—Ö –∞–∫—Ç–∏–≤–æ–≤ –∏ –¥–æ—Ö–æ–¥–∞</li>
                        <li><strong>Deferred Payment:</strong> –î–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö –∫–∞–ø–∏—Ç–∞–ª—å–Ω—ã—Ö –∞–∫—Ç–∏–≤–æ–≤</li>
                        <li><strong>Potential Savings:</strong> –ö–æ–º–±–∏–Ω–∞—Ü–∏—è CHC –∏ LA funding –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π</li>
                    </ul>
                </div>
            </div>
            
            <div style="margin-bottom: 40px;">
                <h3>üìç Postcode Tester</h3>
                <div class="info-section">
                    <h4>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</h4>
                    <p>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è UK postcodes –≤ Local Authority –∏ Region. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–∫ –æ–¥–∏–Ω–æ—á–Ω—ã–µ, —Ç–∞–∫ –∏ –ø–∞–∫–µ—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.</p>
                    
                    <h4>–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>Single Resolver:</strong> –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ postcode —Å –∫–∞—Ä—Ç–æ–π</li>
                        <li><strong>Batch Resolver:</strong> –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö postcodes (–¥–æ 100)</li>
                        <li><strong>–í–∞–ª–∏–¥–∞—Ü–∏—è:</strong> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ UK postcode</li>
                        <li><strong>–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> –û–ø—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∞ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</li>
                        <li><strong>–ö–∞—Ä—Ç–∞:</strong> –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –Ω–∞ OpenStreetMap</li>
                        <li><strong>–î–µ—Ç–∞–ª–∏:</strong> Local Authority, Region, Country, County, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (lat/lon)</li>
                    </ul>
                    
                    <h4>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</h4>
                    <h5>Single Postcode Resolver:</h5>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>–í–≤–µ–¥–∏—Ç–µ UK postcode –≤ –ø–æ–ª–µ "Enter UK Postcode"</li>
                        <li>–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Å–Ω–∏–º–∏—Ç–µ –≥–∞–ª–æ—á–∫—É "Use Cache" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö</li>
                        <li>–ù–∞–∂–º–∏—Ç–µ "Resolve Postcode"</li>
                        <li>–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: Local Authority, Region, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</li>
                        <li>–ò–∑—É—á–∏—Ç–µ –∫–∞—Ä—Ç—É —Å –º–∞—Ä–∫–µ—Ä–æ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è</li>
                    </ol>
                    
                    <h5>Batch Postcode Resolver:</h5>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>–í–≤–µ–¥–∏—Ç–µ postcodes –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</li>
                        <li>–ú–∞–∫—Å–∏–º—É–º 100 postcodes –∑–∞ —Ä–∞–∑</li>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏–∏: Use Cache, Validate Format</li>
                        <li>–ù–∞–∂–º–∏—Ç–µ "Resolve Batch"</li>
                        <li>–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å —Å—Ç–∞—Ç—É—Å–æ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ postcode</li>
                    </ol>
                    
                    <h4>–ü—Ä–∏–º–µ—Ä—ã postcodes</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>England: B15 2HQ, SW1A 1AA, M1 1AA</li>
                        <li>Scotland: EH1 1YZ, G2 4JR</li>
                        <li>Wales: CF10 3AT, SA1 3QQ</li>
                        <li>Northern Ireland: BT1 5GS, BT2 8HS</li>
                    </ul>
                </div>
            </div>
            
            <div style="margin-bottom: 40px;">
                <h3>üìä Data Admin</h3>
                <div class="info-section">
                    <h4>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</h4>
                    <p>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏ MSIF –∏ Lottie. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π.</p>
                    
                    <h4>–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>Initialize Database:</strong> –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</li>
                        <li><strong>Refresh MSIF Data:</strong> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö MSIF –¥–ª—è 2024-2025 –∏ 2025-2026</li>
                        <li><strong>Refresh Lottie Data:</strong> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π Lottie</li>
                        <li><strong>Update Status:</strong> –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∏ –æ—à–∏–±–∫–∞–º–∏</li>
                        <li><strong>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:</strong> –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö –∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</li>
                    </ul>
                    
                    <h4>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</h4>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:</strong>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>–ù–∞–∂–º–∏—Ç–µ "Initialize Database Tables" –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏</li>
                                <li>–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</li>
                            </ul>
                        </li>
                        <li><strong>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MSIF –¥–∞–Ω–Ω—ã—Ö:</strong>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>–ù–∞–∂–º–∏—Ç–µ "üîÑ Refresh MSIF 2025-2026" –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</li>
                                <li>–ò–ª–∏ "üîÑ Refresh MSIF 2024-2025" –¥–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö</li>
                                <li>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞—á–∞–µ—Ç –∏ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç Excel —Ñ–∞–π–ª—ã —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞</li>
                            </ul>
                        </li>
                        <li><strong>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Lottie –¥–∞–Ω–Ω—ã—Ö:</strong>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>–ù–∞–∂–º–∏—Ç–µ "üîÑ Refresh Lottie Data"</li>
                                <li>–°–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∑–∏—Ç —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å —Å–∞–π—Ç–∞ Lottie</li>
                            </ul>
                        </li>
                        <li><strong>–ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞:</strong>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>–ù–∞–∂–º–∏—Ç–µ "üîÑ Refresh Status" –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã</li>
                                <li>–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</li>
                                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å—ã: ‚úÖ success –∏–ª–∏ ‚ùå failed</li>
                                <li>–ò–∑—É—á–∏—Ç–µ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å</li>
                            </ul>
                        </li>
                    </ol>
                    
                    <h4>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>MSIF:</strong> –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ UK Government –æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —É—Ö–æ–¥–∞</li>
                        <li><strong>Lottie:</strong> –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —á–∞—Å—Ç–Ω—ã—Ö –¥–æ–º–æ–≤ –ø—Ä–µ—Å—Ç–∞—Ä–µ–ª—ã—Ö</li>
                    </ul>
                    
                    <h4>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</h4>
                    <p>–°–∏—Å—Ç–µ–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 7 –¥–Ω–µ–π —á–µ—Ä–µ–∑ —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (APScheduler).</p>
                </div>
            </div>
            
            <div style="margin-bottom: 40px;">
                <h3>‚ÑπÔ∏è About</h3>
                <div class="info-section">
                    <h4>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</h4>
                    <p>–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ RightCareHome, –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –≤–µ—Ä—Å–∏–∏.</p>
                    
                    <h4>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</h4>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã</li>
                        <li>–û–ø–∏—Å–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö (MSIF, Lottie, Postcode Mapping)</li>
                        <li>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ Affordability Bands (A-E)</li>
                        <li>API endpoints</li>
                        <li>–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã</li>
                    </ul>
                </div>
            </div>
            
            <div style="background: #e7f3ff; padding: 20px; border-radius: 4px; margin-top: 40px;">
                <h3>üí° –°–æ–≤–µ—Ç—ã –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</h3>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>–ù–∞—á–Ω–∏—Ç–µ —Å <strong>All Locations</strong> –¥–ª—è –æ–±—â–µ–≥–æ –æ–±–∑–æ—Ä–∞ —Ü–µ–Ω –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º</li>
                    <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <strong>Price Calculator</strong> –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤</li>
                    <li>–ü—Ä–∏–º–µ–Ω—è–π—Ç–µ <strong>Savings Calculator</strong> –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∏</li>
                    <li>–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ postcodes —á–µ—Ä–µ–∑ <strong>Postcode Tester</strong> –ø–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–∞–º–∏</li>
                    <li>–†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ <strong>Data Admin</strong> –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏</li>
                    <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –¥–ª—è —É–¥–æ–±–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –¥–∞–Ω–Ω—ã–º</li>
                </ul>
            </div>
        </div>
        
        <!-- Tab 3: About -->
        <div id="about" class="tab-content">
            <h2>About Pricing Calculator</h2>
            
            <div class="info-section">
                <h3>Overview</h3>
                <p>
                    The Pricing Calculator provides comprehensive pricing analysis for UK care homes,
                    combining MSIF Fair Cost data, Lottie regional averages, and postcode mapping to
                    calculate Affordability Bands (A-E) with confidence scores.
                </p>
            </div>
            
            <div class="info-section">
                <h3>Data Sources</h3>
                <p><strong>MSIF Fair Cost Data:</strong> Official UK Government MSIF Fees 2025-2026 median fees by Local Authority.</p>
                <p><strong>Lottie Regional Averages:</strong> 2025 baseline private care home fees by UK region.</p>
                <p><strong>Postcode Mapping:</strong> Cached mapping via postcodes.io API to Local Authority and Region.</p>
            </div>
            
            <div class="info-section">
                <h3>Affordability Bands</h3>
                <ul style="margin-left: 20px; color: #666; line-height: 1.8;">
                    <li><strong>Band A:</strong> Excellent value (‚â§5% above fair cost, or &lt;¬£800/week)</li>
                    <li><strong>Band B:</strong> Good value (5-15% above fair cost, or ¬£800-950/week)</li>
                    <li><strong>Band C:</strong> Fair value (15-25% above fair cost, or ¬£950-1100/week)</li>
                    <li><strong>Band D:</strong> Premium pricing (25-40% above fair cost, or ¬£1100-1300/week)</li>
                    <li><strong>Band E:</strong> Very expensive (&gt;40% above fair cost, or &gt;¬£1300/week)</li>
                </ul>
            </div>
            
            <div class="info-section">
                <h3>API Endpoints</h3>
                <div class="code-block">
GET /api/pricing/locations?care_type=residential&region=London<br>
GET /api/pricing/postcode/{postcode}?care_type=nursing&cqc_rating=Outstanding<br>
GET /api/pricing/regions<br>
GET /api/pricing/care-types
                </div>
            </div>
            
            <div class="info-section">
                <h3>Version</h3>
                <p>Pricing Calculator Module v1.0.0</p>
                <p>Last updated: November 2025</p>
            </div>
        </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8001/api/pricing';
        
        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const menuToggle = document.getElementById('menuToggle');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
            menuToggle.classList.toggle('open');
            
            // Prevent body scroll when sidebar is open
            if (sidebar.classList.contains('open')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }
        
        // Close sidebar when clicking outside (on mobile)
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('open')) {
                toggleSidebar();
            }
        }
        
        // Tab switching from sidebar
        function switchTabFromSidebar(tabName) {
            switchTab(tabName);
            // Close sidebar after selection (especially useful on mobile)
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
        }
        
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            } else {
                // If tab doesn't exist, show external module info
                showExternalModuleInfo(tabName);
                return;
            }
            
            // Update sidebar menu
            const sidebarItems = document.querySelectorAll('.sidebar-menu-item');
            const sidebarMap = {
                'locations': 0,
                'calculator': 1,
                'price_calculator': 2,
                'savings_calculator': 3,
                'postcode_tester': 4,
                'data_admin': 5,
                'help': 6,
                'about': 7
            };
            if (sidebarMap[tabName] !== undefined && sidebarItems[sidebarMap[tabName]]) {
                sidebarItems[sidebarMap[tabName]].classList.add('active');
            }
            
            // Load data if locations tab
            if (tabName === 'locations' && !window.locationsLoaded) {
                loadRegions().then(() => loadData());
            }
        }
        
        // Show info for external modules (Streamlit) - No longer needed, all modules are integrated
        function showExternalModuleInfo(moduleName) {
            // All modules are now integrated, this function is kept for compatibility
            return;
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Create or update external module info tab
            let externalTab = document.getElementById('external_module_info');
            if (!externalTab) {
                externalTab = document.createElement('div');
                externalTab.id = 'external_module_info';
                externalTab.className = 'tab-content';
                document.querySelector('.container').appendChild(externalTab);
            }
            
            externalTab.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <h1 style="font-size: 48px; margin-bottom: 20px;">${info.title}</h1>
                    <p style="font-size: 18px; color: #666; margin-bottom: 40px;">${info.description}</p>
                    
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 30px; max-width: 600px; margin: 0 auto;">
                        <h3 style="margin-bottom: 20px;">üöÄ How to Access</h3>
                        <p style="margin-bottom: 15px; font-family: monospace; background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #667eea;">
                            ${info.instruction}
                        </p>
                        <p style="margin-top: 20px; color: #666;">
                            Then open: <a href="${info.url}" target="_blank" style="color: #667eea; font-weight: bold;">${info.url}</a>
                        </p>
                    </div>
                    
                    <div style="margin-top: 40px; padding: 20px; background: #e7f3ff; border-radius: 10px; max-width: 600px; margin: 40px auto 0;">
                        <p style="color: #666;">
                            <strong>Note:</strong> This module runs as a separate Streamlit application. 
                            Make sure the Streamlit server is running before accessing.
                        </p>
                    </div>
                </div>
            `;
            
            externalTab.classList.add('active');
        }
        
        // Locations tab functions
        let allData = [];
        let regionsLoaded = false;
        
        async function loadRegions() {
            if (regionsLoaded) return;
            try {
                const response = await fetch(`${API_BASE}/regions`);
                const data = await response.json();
                const select = document.getElementById('region');
                data.regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region;
                    option.textContent = region;
                    select.appendChild(option);
                });
                regionsLoaded = true;
            } catch (error) {
                console.error('Failed to load regions:', error);
            }
        }
        
        async function loadData() {
            const loading = document.getElementById('loading');
            const table = document.getElementById('pricingTable');
            const errorDiv = document.getElementById('error');
            
            loading.style.display = 'block';
            table.style.display = 'none';
            errorDiv.style.display = 'none';
            
            try {
                const params = new URLSearchParams();
                
                const careType = document.getElementById('careType').value;
                if (careType) params.append('care_type', careType);
                
                const region = document.getElementById('region').value;
                if (region) params.append('region', region);
                
                const band = document.getElementById('band').value;
                if (band) params.append('band', band);
                
                const minFairCost = document.getElementById('minFairCost').value;
                if (minFairCost) params.append('min_fair_cost', minFairCost);
                
                const maxFairCost = document.getElementById('maxFairCost').value;
                if (maxFairCost) params.append('max_fair_cost', maxFairCost);
                
                const response = await fetch(`${API_BASE}/locations?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const responseData = await response.json();
                allData = responseData.data || responseData;
                
                renderTable(allData);
                updateStats(allData);
                
                loading.style.display = 'none';
                table.style.display = 'table';
                window.locationsLoaded = true;
                
            } catch (error) {
                loading.style.display = 'none';
                errorDiv.textContent = `Error loading data: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }
        
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                
                const fairCost = row.fair_cost_lower_bound_gbp 
                    ? `¬£${row.fair_cost_lower_bound_gbp.toFixed(2)}` 
                    : 'N/A';
                
                const gapClass = row.fair_cost_gap_gbp >= 0 ? 'gap-positive' : 'gap-negative';
                const gapSign = row.fair_cost_gap_gbp >= 0 ? '+' : '';
                
                tr.innerHTML = `
                    <td>${row.local_authority}</td>
                    <td>${row.region}</td>
                    <td>${row.care_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
                    <td class="price">${fairCost}</td>
                    <td class="price">¬£${row.private_average_gbp.toFixed(2)}</td>
                    <td class="${gapClass}">${gapSign}¬£${row.fair_cost_gap_gbp.toFixed(2)}</td>
                    <td class="${gapClass}">${gapSign}${row.fair_cost_gap_percent.toFixed(1)}%</td>
                    <td><span class="band band-${row.affordability_band}">${row.affordability_band}</span></td>
                    <td>${row.band_confidence_percent}%</td>
                `;
                
                tbody.appendChild(tr);
            });
        }
        
        function updateStats(data) {
            const stats = document.getElementById('stats');
            if (data.length === 0) {
                stats.style.display = 'none';
                return;
            }
            
            stats.style.display = 'flex';
            
            document.getElementById('totalLocations').textContent = data.length;
            
            const fairCosts = data.filter(r => r.fair_cost_lower_bound_gbp).map(r => r.fair_cost_lower_bound_gbp);
            const avgFairCost = fairCosts.length > 0 
                ? fairCosts.reduce((a, b) => a + b, 0) / fairCosts.length 
                : 0;
            document.getElementById('avgFairCost').textContent = `¬£${avgFairCost.toFixed(0)}`;
            
            const avgPrivate = data.reduce((sum, r) => sum + r.private_average_gbp, 0) / data.length;
            document.getElementById('avgPrivate').textContent = `¬£${avgPrivate.toFixed(0)}`;
        }
        
        // Calculator tab functions
        async function calculatePostcode() {
            const postcode = document.getElementById('postcodeInput').value.trim();
            const careType = document.getElementById('calcCareType').value;
            const cqcRating = document.getElementById('cqcRating').value || null;
            const facilitiesScore = document.getElementById('facilitiesScore').value ? parseInt(document.getElementById('facilitiesScore').value) : null;
            const bedCount = document.getElementById('bedCount').value ? parseInt(document.getElementById('bedCount').value) : null;
            const isChain = document.getElementById('isChain').checked;
            
            const resultDiv = document.getElementById('calcResult');
            const errorDiv = document.getElementById('calcError');
            
            resultDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            if (!postcode) {
                errorDiv.textContent = 'Please enter a postcode';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const params = new URLSearchParams();
                params.append('care_type', careType);
                if (cqcRating) params.append('cqc_rating', cqcRating);
                if (facilitiesScore) params.append('facilities_score', facilitiesScore);
                if (bedCount) params.append('bed_count', bedCount);
                if (isChain) params.append('is_chain', 'true');
                
                const response = await fetch(`${API_BASE}/postcode/${encodeURIComponent(postcode)}?${params}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="result-card">
                        <h3 style="margin-bottom: 16px;">Pricing Analysis Results</h3>
                        <div class="result-row">
                            <span class="result-label">Postcode:</span>
                            <span class="result-value">${data.postcode}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Local Authority:</span>
                            <span class="result-value">${data.local_authority}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Region:</span>
                            <span class="result-value">${data.region}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Care Type:</span>
                            <span class="result-value">${data.care_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Fair Cost Lower Bound:</span>
                            <span class="result-value">${data.fair_cost_lower_bound_gbp ? '¬£' + data.fair_cost_lower_bound_gbp.toFixed(2) + '/week' : 'N/A'}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Private Average:</span>
                            <span class="result-value">¬£${data.private_average_gbp.toFixed(2)}/week</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Expected Range:</span>
                            <span class="result-value">¬£${data.expected_range_min_gbp.toFixed(2)} - ¬£${data.expected_range_max_gbp.toFixed(2)}/week</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Affordability Band:</span>
                            <span class="result-value"><span class="band band-${data.affordability_band}">${data.affordability_band}</span> (${data.band_confidence_percent}% confidence)</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Fair Cost Gap:</span>
                            <span class="result-value">${data.fair_cost_gap_gbp >= 0 ? '+' : ''}¬£${data.fair_cost_gap_gbp.toFixed(2)} (${data.fair_cost_gap_percent >= 0 ? '+' : ''}${data.fair_cost_gap_percent.toFixed(1)}%)</span>
                        </div>
                        ${data.cqc_rating ? `<div class="result-row">
                            <span class="result-label">CQC Rating:</span>
                            <span class="result-value">${data.cqc_rating}</span>
                        </div>` : ''}
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <h4 style="margin-bottom: 12px;">Negotiation Leverage Text:</h4>
                            <div style="background: white; padding: 12px; border-radius: 4px; white-space: pre-wrap; font-size: 13px; line-height: 1.6;">${data.negotiation_leverage_text}</div>
                        </div>
                    </div>
                `;
                
                resultDiv.style.display = 'block';
                
            } catch (error) {
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }
        
        // Event listeners for filters
        document.getElementById('careType').addEventListener('change', loadData);
        document.getElementById('region').addEventListener('change', loadData);
        document.getElementById('band').addEventListener('change', loadData);
        document.getElementById('minFairCost').addEventListener('input', loadData);
        document.getElementById('maxFairCost').addEventListener('input', loadData);
        
        // Allow Enter key in postcode input
        document.getElementById('postcodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculatePostcode();
            }
        });
        
        // Close sidebar on window resize (if it becomes desktop view)
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('open')) {
                    // Keep sidebar open on desktop, but remove overlay
                    document.getElementById('overlay').classList.remove('show');
                }
            }
        });
        
        // Close sidebar when pressing Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSidebar();
            }
        });
        
        // Price Calculator functions
        async function calculatePrice(event) {
            event.preventDefault();
            
            const errorDiv = document.getElementById('priceError');
            const resultDiv = document.getElementById('priceResult');
            
            errorDiv.style.display = 'none';
            resultDiv.style.display = 'none';
            
            const postcode = document.getElementById('pricePostcode').value.trim();
            const careType = document.getElementById('priceCareType').value;
            const cqcRating = document.getElementById('priceCqcRating').value || null;
            const facilitiesScore = parseInt(document.getElementById('priceFacilitiesScore').value) || null;
            const bedCount = parseInt(document.getElementById('priceBedCount').value) || null;
            const isChain = document.getElementById('priceIsChain').checked;
            const scrapedPrice = parseFloat(document.getElementById('priceScrapedPrice').value) || null;
            
            if (!postcode) {
                errorDiv.textContent = 'Please enter a postcode';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const params = new URLSearchParams();
                params.append('postcode', postcode);
                params.append('care_type', careType);
                if (cqcRating) params.append('cqc_rating', cqcRating);
                if (facilitiesScore !== null) params.append('facilities_score', facilitiesScore);
                if (bedCount !== null) params.append('bed_count', bedCount);
                if (isChain) params.append('is_chain', 'true');
                if (scrapedPrice !== null) params.append('scraped_price', scrapedPrice);
                
                const url = `http://localhost:8001/api/pricing-core/calculate?${params}`;
                console.log('Fetching pricing from:', url);
                
                // Show loading state
                errorDiv.textContent = 'Calculating pricing...';
                errorDiv.style.display = 'block';
                errorDiv.className = 'info';
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorMessage;
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                errorDiv.style.display = 'none';
                displayPriceResult(result);
                
            } catch (error) {
                console.error('Pricing calculation error:', error);
                let errorMessage = error.message;
                
                // Provide more helpful error messages
                if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
                    errorMessage = 'Failed to connect to the API server. Please ensure the server is running on http://localhost:8001. Run: ./run_pricing_api.sh';
                } else if (error.message.includes('NetworkError') || error.message.includes('network')) {
                    errorMessage = 'Network error. Please check if the API server is running on http://localhost:8001';
                }
                
                errorDiv.textContent = `Error: ${errorMessage}`;
                errorDiv.style.display = 'block';
                errorDiv.className = 'error';
            }
        }
        
        function displayPriceResult(result) {
            const resultDiv = document.getElementById('priceResult');
            
            // Store result globally for PDF download
            window.lastPriceResult = result;
            
            const bandColors = {
                'A': '#28a745',
                'B': '#28a745',
                'C': '#ffc107',
                'D': '#fd7e14',
                'E': '#dc3545'
            };
            
            const bandColor = bandColors[result.affordability_band] || '#666';
            const confidenceColor = result.band_confidence_percent >= 80 ? '#28a745' : 
                                   result.band_confidence_percent >= 70 ? '#ffc107' : '#dc3545';
            
            let adjustmentsHtml = '';
            if (result.adjustments && Object.keys(result.adjustments).length > 0) {
                adjustmentsHtml = '<div style="margin-top: 20px;"><h3>üìä Adjustments Applied</h3><table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f8f9fa;"><th style="padding: 8px; text-align: left;">Factor</th><th style="padding: 8px; text-align: left;">Adjustment</th><th style="padding: 8px; text-align: left;">Impact</th></tr></thead><tbody>';
                for (const [name, value] of Object.entries(result.adjustments)) {
                    adjustmentsHtml += `<tr><td style="padding: 8px; border-bottom: 1px solid #eee;">${name.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</td><td style="padding: 8px; border-bottom: 1px solid #eee;">${(value * 100).toFixed(1)}%</td><td style="padding: 8px; border-bottom: 1px solid #eee;">¬£${(result.base_price_gbp * value).toFixed(2)}/week</td></tr>`;
                }
                adjustmentsHtml += `</tbody></table><p style="margin-top: 10px; color: #666;">Total Adjustment: ${result.adjustment_total_percent.toFixed(1)}%</p></div>`;
            }
            
            // Get current form values for PDF download
            const postcode = document.getElementById('pricePostcode').value.trim();
            const careType = document.getElementById('priceCareType').value;
            const cqcRating = document.getElementById('priceCqcRating').value || null;
            const facilitiesScore = parseInt(document.getElementById('priceFacilitiesScore').value) || null;
            const bedCount = parseInt(document.getElementById('priceBedCount').value) || null;
            const isChain = document.getElementById('priceIsChain').checked;
            
            resultDiv.innerHTML = `
                <div style="background: #d4edda; border-left: 4px solid #28a745; padding: 20px; border-radius: 4px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #155724;">‚úÖ Pricing Calculated Successfully!</h3>
                </div>
                
                <div class="stats" style="margin-bottom: 20px;">
                    <div class="stat">
                        <span class="stat-value">¬£${result.final_price_gbp.toFixed(2)}</span>
                        <span class="stat-label">Final Price/week</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">${result.msif_lower_bound_gbp ? '¬£' + result.msif_lower_bound_gbp.toFixed(2) : 'N/A'}</span>
                        <span class="stat-label">MSIF Lower Bound</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">¬£${result.base_price_gbp.toFixed(2)}</span>
                        <span class="stat-label">Base Price (Lottie)</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">¬£${result.expected_range_min_gbp.toFixed(2)} - ¬£${result.expected_range_max_gbp.toFixed(2)}</span>
                        <span class="stat-label">Expected Range</span>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 4px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0;">üéØ Affordability Band</h3>
                    <div style="display: flex; gap: 30px; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-size: 48px; font-weight: bold; color: ${bandColor}; margin-bottom: 10px;">
                                Band ${result.affordability_band}
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong>Band Score:</strong> ${result.band_score.toFixed(3)}
                            </div>
                            <div>
                                <strong>Confidence:</strong>
                                <div style="background: #e9ecef; height: 20px; border-radius: 10px; margin-top: 5px; overflow: hidden;">
                                    <div style="background: ${confidenceColor}; height: 100%; width: ${result.band_confidence_percent}%; transition: width 0.3s;"></div>
                                </div>
                                <div style="margin-top: 5px; color: #666;">${result.band_confidence_percent}%</div>
                            </div>
                        </div>
                        <div style="flex: 2;">
                            <strong>Reasoning:</strong>
                            <div style="background: white; padding: 15px; border-radius: 4px; margin-top: 10px; border-left: 3px solid ${bandColor};">
                                ${result.band_reasoning}
                            </div>
                        </div>
                    </div>
                </div>
                
                ${adjustmentsHtml}
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 4px; margin-top: 20px;">
                    <h3 style="margin-top: 0;">üìà Gap Analysis</h3>
                    <div style="display: flex; gap: 20px;">
                        <div>
                            <strong>Fair Cost Gap:</strong><br>
                            <span style="font-size: 24px; font-weight: bold;">¬£${result.fair_cost_gap_gbp.toFixed(2)}</span><br>
                            <span style="color: #666;">${result.fair_cost_gap_percent >= 0 ? '+' : ''}${result.fair_cost_gap_percent.toFixed(1)}%</span>
                        </div>
                        <div>
                            ${result.scraped_price_gbp ? 
                                `<strong>üí∞ Using scraped price:</strong><br>¬£${result.scraped_price_gbp.toFixed(2)}/week` :
                                '<strong>üìä Using calculated price</strong>'
                            }
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>üíº Negotiation Leverage Text</h3>
                    <textarea readonly style="width: 100%; min-height: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 14px;">${result.negotiation_leverage_text}</textarea>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn" onclick="downloadPricePDF('${postcode}', '${careType}', '${cqcRating || ''}', ${facilitiesScore || 'null'}, ${bedCount || 'null'}, ${isChain})" style="flex: 1;">
                        üìÑ Download PDF Report
                    </button>
                    <button class="btn" onclick="saveScrapedPrice(${result.final_price_gbp})" style="background: #6c757d;">
                        üíæ Save as Scraped Price
                    </button>
                </div>
            `;
            
            resultDiv.style.display = 'block';
        }
        
        // Download PDF for Price Calculator
        async function downloadPricePDF(postcode, careType, cqcRating, facilitiesScore, bedCount, isChain) {
            const params = new URLSearchParams();
            params.append('postcode', postcode);
            params.append('care_type', careType);
            if (cqcRating) params.append('cqc_rating', cqcRating);
            if (facilitiesScore !== null && facilitiesScore !== 'null') params.append('facilities_score', facilitiesScore);
            if (bedCount !== null && bedCount !== 'null') params.append('bed_count', bedCount);
            // Convert to boolean if it's a string (from template interpolation)
            const isChainBool = isChain === true || isChain === 'true' || isChain === 'True';
            params.append('is_chain', isChainBool ? 'true' : 'false');
            
            try {
                const url = `http://localhost:8001/api/pricing-core/generate-pdf?${params}`;
                console.log('Generating PDF from:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorMessage;
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                    }
                    console.error('PDF generation error:', errorMessage);
                    throw new Error(errorMessage);
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `price_report_${postcode.replace(/\s+/g, '_')}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                document.body.removeChild(a);
                
                alert('‚úÖ PDF report downloaded successfully!');
            } catch (error) {
                console.error('PDF generation error:', error);
                alert(`‚ùå Error generating PDF: ${error.message}`);
            }
        }
        
        function saveScrapedPrice(price) {
            document.getElementById('priceScrapedPrice').value = price.toFixed(2);
            alert(`‚úÖ Saved scraped price: ¬£${price.toFixed(2)}/week\n\nYou can use this value for future calculations.`);
        }
        
        // Savings Calculator functions
        async function calculateSavings(event) {
            event.preventDefault();
            
            const errorDiv = document.getElementById('savingsError');
            const resultDiv = document.getElementById('savingsResult');
            
            errorDiv.style.display = 'none';
            resultDiv.style.display = 'none';
            
            const params = new URLSearchParams();
            params.append('postcode', document.getElementById('savingsPostcode').value.trim());
            params.append('care_type', document.getElementById('savingsCareType').value);
            params.append('age', document.getElementById('savingsAge').value);
            params.append('has_primary_health_need', document.getElementById('savingsPrimaryHealthNeed').checked);
            params.append('has_dementia', document.getElementById('savingsDementia').checked);
            params.append('has_parkinsons', document.getElementById('savingsParkinsons').checked);
            params.append('has_stroke', false);
            params.append('has_diabetes', false);
            params.append('has_heart_condition', false);
            params.append('requires_nursing_care', document.getElementById('savingsNursingCare').checked);
            params.append('mobility_level', document.getElementById('savingsMobility').value);
            params.append('requires_personal_care', false);
            params.append('requires_medication_management', false);
            params.append('capital_assets', document.getElementById('savingsCapitalAssets').value || 0);
            params.append('weekly_income', document.getElementById('savingsWeeklyIncome').value || 0);
            const careCost = document.getElementById('savingsCareCost').value;
            if (careCost && parseFloat(careCost) > 0) {
                params.append('care_cost_per_week', careCost);
            }
            
            try {
                const url = `http://localhost:8001/api/funding/calculate-savings?${params}`;
                console.log('Fetching:', url); // Debug log
                
                // Show loading state
                errorDiv.textContent = 'Calculating...';
                errorDiv.style.display = 'block';
                errorDiv.className = 'info';
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorMessage;
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                errorDiv.style.display = 'none';
                displaySavingsResult(result);
                
            } catch (error) {
                console.error('Error calculating savings:', error);
                errorDiv.className = 'error';
                if (error.name === 'AbortError' || error.message.includes('timeout')) {
                    errorDiv.textContent = 'Request timeout. Please check if the server is running on port 8001.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorDiv.textContent = 'Failed to connect to server. Please ensure the API server is running on http://localhost:8001';
                } else {
                    errorDiv.textContent = `Error: ${error.message}`;
                }
                errorDiv.style.display = 'block';
            }
        }
        
        function displaySavingsResult(result) {
            const resultDiv = document.getElementById('savingsResult');
            const eligibility = result.eligibility;
            const fairCost = result.fair_cost_gap;
            
            resultDiv.innerHTML = `
                <div style="background-color: #f8d7da; border-left: 5px solid #dc3545; padding: 30px; margin: 20px 0; border-radius: 5px;">
                    <h2 style="color: #721c24; margin-top: 0;">‚ö†Ô∏è Fair Cost Gap</h2>
                    <div style="display: flex; justify-content: space-around; margin: 30px 0;">
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: #721c24;">¬£${fairCost.weekly_gap.toFixed(2)}</div>
                            <div style="color: #721c24; font-size: 18px;">per week</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: #721c24;">¬£${Math.round(fairCost.yearly_gap).toLocaleString()}</div>
                            <div style="color: #721c24; font-size: 18px;">per year</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: #721c24;">¬£${Math.round(fairCost.five_year_gap).toLocaleString()}</div>
                            <div style="color: #721c24; font-size: 18px;">over 5 years</div>
                        </div>
                    </div>
                    <p style="color: #721c24; font-size: 16px; margin-bottom: 0;">${fairCost.emotional_text}</p>
                </div>
                
                ${eligibility.potential_savings_per_year > 0 ? `
                <div style="background-color: #d4edda; border-left: 5px solid #28a745; padding: 30px; margin: 20px 0; border-radius: 5px;">
                    <h2 style="color: #155724; margin-top: 0;">‚úÖ Potential Savings</h2>
                    <div style="display: flex; justify-content: space-around; margin: 30px 0;">
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: #155724;">¬£${eligibility.potential_savings_per_week.toFixed(2)}</div>
                            <div style="color: #155724; font-size: 18px;">per week</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: #155724;">¬£${Math.round(eligibility.potential_savings_per_year).toLocaleString()}</div>
                            <div style="color: #155724; font-size: 18px;">per year</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: bold; color: #155724;">¬£${Math.round(eligibility.potential_savings_5_years).toLocaleString()}</div>
                            <div style="color: #155724; font-size: 18px;">over 5 years</div>
                        </div>
                    </div>
                    <p style="color: #155724; font-size: 16px; margin-bottom: 0;">
                        These savings are based on potential CHC eligibility and Local Authority funding options.
                    </p>
                </div>
                ` : ''}
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 4px; margin-top: 20px;">
                    <h3>üè• CHC Eligibility Assessment</h3>
                    <div style="display: flex; gap: 30px;">
                        <div style="flex: 1;">
                            <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">
                                ${eligibility.chc_eligibility.probability_percent}%
                            </div>
                            <div style="background: #e9ecef; height: 20px; border-radius: 10px; margin-bottom: 10px; overflow: hidden;">
                                <div style="background: ${eligibility.chc_eligibility.probability_percent >= 70 ? '#28a745' : eligibility.chc_eligibility.probability_percent >= 50 ? '#ffc107' : '#dc3545'}; height: 100%; width: ${eligibility.chc_eligibility.probability_percent}%;"></div>
                            </div>
                            <p>${eligibility.chc_eligibility.is_likely_eligible ? '‚úÖ Likely eligible for CHC funding' : '‚ÑπÔ∏è May not meet CHC threshold'}</p>
                        </div>
                        <div style="flex: 2;">
                            <strong>Key Factors:</strong>
                            <ul style="margin-top: 10px;">
                                ${eligibility.chc_eligibility.key_factors.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            <p style="margin-top: 10px; color: #666;">${eligibility.chc_eligibility.reasoning}</p>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 4px; margin-top: 20px;">
                    <h3>üèõÔ∏è Local Authority Funding</h3>
                    <div style="display: flex; gap: 30px;">
                        <div style="flex: 1;">
                            <p><strong>Top-up Probability:</strong> ${eligibility.la_funding.top_up_probability_percent}%</p>
                            <p>${eligibility.la_funding.deferred_payment_eligible ? '‚úÖ Eligible for Deferred Payment' : '‚ÑπÔ∏è Not eligible for Deferred Payment'}</p>
                            ${eligibility.la_funding.weekly_contribution ? `<p><strong>Weekly Contribution:</strong> ¬£${eligibility.la_funding.weekly_contribution.toFixed(2)}</p>` : ''}
                        </div>
                        <div style="flex: 2;">
                            <p style="color: #666;">${eligibility.la_funding.deferred_payment_reasoning}</p>
                        </div>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 4px; margin-top: 20px;">
                    <h3>üí° Recommendations</h3>
                    <ol style="margin-left: 20px;">
                        ${eligibility.recommendations.map(r => `<li style="margin-bottom: 10px;">${r}</li>`).join('')}
                    </ol>
                </div>
                
                <div style="text-align: center; padding: 40px; background-color: #f8f9fa; border-radius: 10px; margin-top: 30px;">
                    <h2 style="color: #333;">Get Your Full Funding Report</h2>
                    <p style="font-size: 18px; color: #666; margin: 20px 0;">
                        Detailed analysis, personalized recommendations, and step-by-step guidance
                    </p>
                    <div style="font-size: 32px; font-weight: bold; color: #28a745; margin: 20px 0;">
                        ¬£119
                    </div>
                    <button class="btn" onclick="downloadSavingsPDF()" style="margin-top: 20px;">
                        üìÑ Download PDF Report
                    </button>
                    <button class="btn" onclick="alert('Full detailed report (¬£119) - Coming soon!')" style="margin-top: 10px; background: #6c757d;">
                        üíº Get Full Report - ¬£119
                    </button>
                </div>
            `;
            
            resultDiv.style.display = 'block';
        }
        
        // Download PDF for Savings Calculator
        async function downloadSavingsPDF() {
            // Collect domain assessments
            const domainAssessments = {};
            DOMAINS.forEach(domain => {
                const level = document.getElementById(`domain_${domain.key}_level`).value;
                const desc = document.getElementById(`domain_${domain.key}_desc`).value;
                
                if (level !== 'no') {
                    domainAssessments[domain.key] = {
                        domain: domain.key,
                        level: level,
                        description: desc || `${level} needs in ${domain.key}`
                    };
                }
            });
            
            // Build patient profile
            const patientProfile = {
                age: parseInt(document.getElementById('savingsAge').value) || 80,
                domain_assessments: domainAssessments,
                has_primary_health_need: document.getElementById('savingsPrimaryHealthNeed').checked,
                requires_nursing_care: document.getElementById('savingsRequiresNursingCare').checked,
                has_peg_feeding: document.getElementById('savingsPegFeeding').checked,
                has_tracheostomy: document.getElementById('savingsTracheostomy').checked,
                requires_injections: document.getElementById('savingsRequiresInjections').checked,
                requires_ventilator: document.getElementById('savingsRequiresVentilator').checked,
                requires_dialysis: document.getElementById('savingsRequiresDialysis').checked,
                has_unpredictable_needs: document.getElementById('savingsUnpredictableNeeds').checked,
                has_fluctuating_condition: document.getElementById('savingsFluctuatingCondition').checked,
                has_high_risk_behaviours: document.getElementById('savingsHighRiskBehaviours').checked,
                capital_assets: parseFloat(document.getElementById('savingsCapitalAssets').value) || 0,
                weekly_income: parseFloat(document.getElementById('savingsWeeklyIncome').value) || 0,
                care_type: document.getElementById('savingsCareType').value,
                is_permanent_care: document.getElementById('savingsIsPermanentCare').checked
            };
            
            // Add property if exists
            if (document.getElementById('savingsHasProperty').checked) {
                patientProfile.property = {
                    value: parseFloat(document.getElementById('savingsPropertyValue').value) || 0,
                    is_main_residence: document.getElementById('savingsIsMainResidence').checked,
                    has_qualifying_relative: document.getElementById('savingsHasQualifyingRelative').checked,
                    qualifying_relative_details: document.getElementById('savingsQualifyingRelativeDetails').value || null
                };
            }
            
            const postcode = document.getElementById('savingsPostcode').value.trim() || 'B15 2HQ';
            const careType = patientProfile.care_type;
            
            try {
                // Use POST endpoint with full profile
                const response = await fetch('http://localhost:8001/api/funding/calculate-full', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        patient_profile: patientProfile,
                        postcode: postcode,
                        care_type: careType,
                        user_id: 'web_user',
                        use_cache: true
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Generate PDF from result
                const pdfResponse = await fetch('http://localhost:8001/api/funding/generate-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patient_profile: patientProfile,
                        postcode: postcode,
                        care_type: careType
                    })
                });
                
                if (!pdfResponse.ok) {
                    const errorData = await pdfResponse.json().catch(() => ({ detail: `HTTP error! status: ${pdfResponse.status}` }));
                    throw new Error(errorData.detail || `HTTP error! status: ${pdfResponse.status}`);
                }
                
                const blob = await pdfResponse.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `funding_report_${document.getElementById('savingsPostcode').value.replace(/\s+/g, '_')}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                document.body.removeChild(a);
                
                alert('‚úÖ PDF report downloaded successfully!');
            } catch (error) {
                alert(`‚ùå Error generating PDF: ${error.message}`);
            }
        }
        
        // Postcode Tester functions
        async function resolveSinglePostcode() {
            const postcode = document.getElementById('postcodeInput').value.trim();
            const useCache = document.getElementById('postcodeUseCache').checked;
            const errorDiv = document.getElementById('postcodeError');
            const resultDiv = document.getElementById('postcodeResult');
            
            errorDiv.style.display = 'none';
            resultDiv.style.display = 'none';
            
            if (!postcode) {
                errorDiv.textContent = 'Please enter a postcode';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:8001/api/postcode/resolve/${encodeURIComponent(postcode)}?use_cache=${useCache}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                resultDiv.innerHTML = `
                    <div style="background: #d4edda; border-left: 4px solid #28a745; padding: 20px; border-radius: 4px; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; color: #155724;">‚úÖ Postcode resolved: ${result.postcode}</h3>
                    </div>
                    
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-value">${result.local_authority}</span>
                            <span class="stat-label">Local Authority</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${result.region}</span>
                            <span class="stat-label">Region</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${result.lat.toFixed(6)}</span>
                            <span class="stat-label">Latitude</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${result.lon.toFixed(6)}</span>
                            <span class="stat-label">Longitude</span>
                        </div>
                    </div>
                    
                    ${result.country ? `<p><strong>Country:</strong> ${result.country}</p>` : ''}
                    ${result.county ? `<p><strong>County:</strong> ${result.county}</p>` : ''}
                    
                    <div style="margin-top: 20px;">
                        <h4>Map Location</h4>
                        <iframe 
                            width="100%" 
                            height="400" 
                            frameborder="0" 
                            style="border:0; border-radius: 4px;"
                            src="https://www.openstreetmap.org/export/embed.html?bbox=${result.lon-0.01},${result.lat-0.01},${result.lon+0.01},${result.lat+0.01}&layer=mapnik&marker=${result.lat},${result.lon}"
                            allowfullscreen>
                        </iframe>
                    </div>
                `;
                
                resultDiv.style.display = 'block';
                
            } catch (error) {
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }
        
        async function resolveBatchPostcodes() {
            const postcodesText = document.getElementById('batchPostcodes').value.trim();
            const useCache = document.getElementById('batchUseCache').checked;
            const validate = document.getElementById('batchValidate').checked;
            const errorDiv = document.getElementById('batchError');
            const resultDiv = document.getElementById('batchResult');
            
            errorDiv.style.display = 'none';
            resultDiv.style.display = 'none';
            
            if (!postcodesText) {
                errorDiv.textContent = 'Please enter at least one postcode';
                errorDiv.style.display = 'block';
                return;
            }
            
            const postcodes = postcodesText.split('\n').map(p => p.trim()).filter(p => p);
            
            if (postcodes.length > 100) {
                errorDiv.textContent = 'Maximum 100 postcodes per batch';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const params = new URLSearchParams();
                postcodes.forEach(p => params.append('postcodes', p));
                params.append('use_cache', useCache);
                params.append('validate', validate);
                
                const response = await fetch(`http://localhost:8001/api/postcode/resolve-batch?${params}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                let tableRows = '';
                result.results.forEach((r, i) => {
                    if (r) {
                        tableRows += `
                            <tr>
                                <td>${postcodes[i]}</td>
                                <td>${r.local_authority}</td>
                                <td>${r.region}</td>
                                <td>${r.country || ''}</td>
                                <td>${r.lat.toFixed(6)}</td>
                                <td>${r.lon.toFixed(6)}</td>
                                <td style="color: green;">‚úÖ Found</td>
                            </tr>
                        `;
                    } else {
                        tableRows += `
                            <tr>
                                <td>${postcodes[i]}</td>
                                <td colspan="6" style="color: red;">‚ùå Not Found</td>
                            </tr>
                        `;
                    }
                });
                
                resultDiv.innerHTML = `
                    <div class="stats">
                        <div class="stat">
                            <span class="stat-value">${result.total}</span>
                            <span class="stat-label">Total</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${result.found}</span>
                            <span class="stat-label">Found</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${result.not_found}</span>
                            <span class="stat-label">Not Found</span>
                        </div>
                    </div>
                    
                    <table class="data-table" style="margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>Postcode</th>
                                <th>Local Authority</th>
                                <th>Region</th>
                                <th>Country</th>
                                <th>Lat</th>
                                <th>Lon</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                `;
                
                resultDiv.style.display = 'block';
                
            } catch (error) {
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }
        
        // Data Admin functions
        async function initDatabase() {
            try {
                const response = await fetch('http://localhost:8001/api/data-admin/init-database', { method: 'POST' });
                const result = await response.json();
                if (response.ok) {
                    alert('‚úÖ Database tables initialized successfully');
                } else {
                    alert(`‚ùå Error: ${result.detail || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        async function refreshMSIF(year) {
            try {
                console.log(`Refreshing MSIF ${year}...`);
                const response = await fetch(`http://localhost:8001/api/data-admin/refresh-msif/${year}`, { 
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log(`Response status: ${response.status}`);
                
                if (!response.ok) {
                    // Try to get error details from response
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.error || errorMessage;
                        console.error('Error response:', errorData);
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                        console.error('Error text:', errorText);
                    }
                    alert(`‚ùå Error refreshing MSIF ${year}: ${errorMessage}`);
                    return;
                }
                
                const result = await response.json();
                console.log('Result:', result);
                
                if (result.status === 'success') {
                    const sourceInfo = result.source ? ` (from ${result.source})` : '';
                    let message = `‚úÖ ${result.data_source} updated successfully! Records: ${result.records_updated}${sourceInfo}`;
                    
                    // Show warning if data was parsed but not saved
                    if (result.records_updated === 0 && result.warning) {
                        message += `\n\n‚ö†Ô∏è Warning: ${result.warning}`;
                    }
                    
                    alert(message);
                    loadUpdateStatus();
                } else {
                    const errorMsg = result.error || 'Unknown error';
                    console.error('Error in result:', errorMsg);
                    alert(`‚ùå Error: ${errorMsg}`);
                }
            } catch (error) {
                console.error('Exception refreshing MSIF:', error);
                const errorMsg = error.message || 'Failed to connect to server. Please ensure the API server is running on http://localhost:8001';
                alert(`‚ùå Error: ${errorMsg}`);
            }
        }
        
        async function refreshLottie() {
            try {
                console.log('Refreshing Lottie data...');
                const response = await fetch('http://localhost:8001/api/data-admin/refresh-lottie', { 
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log(`Response status: ${response.status}`);
                
                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.error || errorMessage;
                        console.error('Error response:', errorData);
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                        console.error('Error text:', errorText);
                    }
                    alert(`‚ùå Error refreshing Lottie data: ${errorMessage}`);
                    return;
                }
                
                const result = await response.json();
                console.log('Result:', result);
                
                if (result.status === 'success') {
                    alert(`‚úÖ ${result.data_source} updated successfully! Records: ${result.records_updated}`);
                    loadUpdateStatus();
                } else {
                    const errorMsg = result.error || 'Unknown error';
                    console.error('Error in result:', errorMsg);
                    alert(`‚ùå Error: ${errorMsg}`);
                }
            } catch (error) {
                console.error('Exception refreshing Lottie:', error);
                const errorMsg = error.message || 'Failed to connect to server. Please ensure the API server is running on http://localhost:8001';
                alert(`‚ùå Error: ${errorMsg}`);
            }
        }
        
        async function loadUpdateStatus() {
            const errorDiv = document.getElementById('updateStatusError');
            const resultDiv = document.getElementById('updateStatusResult');
            
            errorDiv.style.display = 'none';
            resultDiv.style.display = 'none';
            
            try {
                const response = await fetch('http://localhost:8001/api/data-admin/update-status');
                const result = await response.json();
                
                if (result.updates && result.updates.length > 0) {
                    let tableRows = '';
                    result.updates.forEach(u => {
                        const statusEmoji = u.status === 'success' ? '‚úÖ' : '‚ùå';
                        tableRows += `
                            <tr>
                                <td>${u.id}</td>
                                <td>${u.data_source}</td>
                                <td>${statusEmoji} ${u.status}</td>
                                <td>${u.records_updated || 0}</td>
                                <td>${u.started_at ? new Date(u.started_at).toLocaleString() : ''}</td>
                                <td>${u.completed_at ? new Date(u.completed_at).toLocaleString() : ''}</td>
                                <td>${u.duration_seconds || ''}</td>
                                <td>${u.error_message || ''}</td>
                            </tr>
                        `;
                    });
                    
                    const successCount = result.updates.filter(u => u.status === 'success').length;
                    const failedCount = result.updates.filter(u => u.status === 'failed').length;
                    
                    resultDiv.innerHTML = `
                        <div class="stats">
                            <div class="stat">
                                <span class="stat-value">${result.total}</span>
                                <span class="stat-label">Total Updates</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value">${successCount}</span>
                                <span class="stat-label">Successful</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value">${failedCount}</span>
                                <span class="stat-label">Failed</span>
                            </div>
                        </div>
                        
                        <table class="data-table" style="margin-top: 20px;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data Source</th>
                                    <th>Status</th>
                                    <th>Records</th>
                                    <th>Started</th>
                                    <th>Completed</th>
                                    <th>Duration (s)</th>
                                    <th>Error</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    `;
                } else {
                    resultDiv.innerHTML = '<p style="color: #666;">No update logs found. Run a refresh to see status.</p>';
                }
                
                resultDiv.style.display = 'block';
                
            } catch (error) {
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }
        
        // Savings Calculator - New Interface Functions
        const DOMAINS = [
            { key: 'breathing', name: 'Breathing', desc: 'Respiratory function, oxygen needs' },
            { key: 'nutrition', name: 'Nutrition', desc: 'Eating, drinking, swallowing' },
            { key: 'continence', name: 'Continence', desc: 'Bladder and bowel control' },
            { key: 'skin', name: 'Skin', desc: 'Wound care, pressure sores, skin integrity' },
            { key: 'mobility', name: 'Mobility', desc: 'Movement, transfers, positioning' },
            { key: 'communication', name: 'Communication', desc: 'Speech, understanding, expression' },
            { key: 'psychological', name: 'Psychological', desc: 'Mental health, emotional needs' },
            { key: 'cognition', name: 'Cognition', desc: 'Memory, orientation, decision-making' },
            { key: 'behaviour', name: 'Behaviour', desc: 'Challenging behaviours, safety' },
            { key: 'drug_therapies', name: 'Drug Therapies', desc: 'Medication management, complex therapies' },
            { key: 'altered_states', name: 'Altered States', desc: 'Consciousness, awareness' },
            { key: 'other', name: 'Other', desc: 'Additional needs not covered above' }
        ];
        
        const DOMAIN_LEVELS = [
            { value: 'no', label: 'NO - No needs' },
            { value: 'low', label: 'LOW - Low needs - Some support required' },
            { value: 'moderate', label: 'MODERATE - Moderate needs - Regular support required' },
            { value: 'high', label: 'HIGH - High needs - Intensive support required' },
            { value: 'severe', label: 'SEVERE - Severe needs - Very intensive support required' },
            { value: 'priority', label: 'PRIORITY - Priority needs - Critical, life-threatening' }
        ];
        
        function initDomainAssessments() {
            const container = document.getElementById('domainAssessments');
            if (!container) return;
            
            container.innerHTML = '';
            
            DOMAINS.forEach(domain => {
                const card = document.createElement('div');
                card.className = 'domain-card';
                card.innerHTML = `
                    <h4>${domain.name}</h4>
                    <p style="color: #666; font-size: 12px; margin: 5px 0;">${domain.desc}</p>
                    <select id="domain_${domain.key}_level" onchange="updateDomainAssessment('${domain.key}')">
                        ${DOMAIN_LEVELS.map(level => 
                            `<option value="${level.value}">${level.label}</option>`
                        ).join('')}
                    </select>
                    <textarea 
                        id="domain_${domain.key}_desc" 
                        placeholder="Describe the needs in this domain..."
                        style="display: none;"
                        onchange="updateDomainAssessment('${domain.key}')"
                    ></textarea>
                `;
                container.appendChild(card);
            });
        }
        
        function updateDomainAssessment(domainKey) {
            const levelSelect = document.getElementById(`domain_${domainKey}_level`);
            const descTextarea = document.getElementById(`domain_${domainKey}_desc`);
            
            if (levelSelect.value !== 'no') {
                descTextarea.style.display = 'block';
            } else {
                descTextarea.style.display = 'none';
                descTextarea.value = '';
            }
        }
        
        function switchSavingsTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.savings-tab-content').forEach(t => {
                t.classList.remove('active');
                t.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.savings-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const tabElement = document.getElementById(`savings${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`);
            if (tabElement) {
                tabElement.classList.add('active');
                tabElement.style.display = 'block';
            }
            
            // Activate button
            const btn = document.getElementById(`savingsTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            if (btn) {
                btn.classList.add('active');
            }
            
            // Initialize domains on first load
            const domainContainer = document.getElementById('domainAssessments');
            if (tab === 'domains' && domainContainer && !domainContainer.hasChildNodes()) {
                console.log('Initializing domains for domains tab');
                initDomainAssessments();
            }
            
            // Also initialize when switching to results tab (in case domains weren't initialized)
            if (tab === 'results' && domainContainer && !domainContainer.hasChildNodes()) {
                console.log('Initializing domains for results tab');
                initDomainAssessments();
            }
        }
        
        // Property details toggle
        document.addEventListener('DOMContentLoaded', function() {
            const hasPropertyCheckbox = document.getElementById('savingsHasProperty');
            const propertyDetails = document.getElementById('propertyDetails');
            const qualifyingRelativeCheckbox = document.getElementById('savingsHasQualifyingRelative');
            const qualifyingRelativeDetails = document.getElementById('savingsQualifyingRelativeDetails');
            
            if (hasPropertyCheckbox && propertyDetails) {
                hasPropertyCheckbox.addEventListener('change', function() {
                    propertyDetails.style.display = this.checked ? 'block' : 'none';
                });
            }
            
            if (qualifyingRelativeCheckbox && qualifyingRelativeDetails) {
                qualifyingRelativeCheckbox.addEventListener('change', function() {
                    qualifyingRelativeDetails.style.display = this.checked ? 'block' : 'none';
                });
            }
            
            // Initialize domains when savings calculator tab is opened
            const savingsTab = document.getElementById('savings_calculator');
            if (savingsTab) {
                const observer = new MutationObserver(function(mutations) {
                    if (savingsTab.classList.contains('active')) {
                        setTimeout(() => {
                            const domainContainer = document.getElementById('domainAssessments');
                            if (domainContainer && !domainContainer.hasChildNodes()) {
                                console.log('Initializing domain assessments...');
                                initDomainAssessments();
                            }
                        }, 100);
                    }
                });
                
                observer.observe(savingsTab, { attributes: true, attributeFilter: ['class'] });
                
                // Also initialize immediately if tab is already active
                if (savingsTab.classList.contains('active')) {
                    setTimeout(() => {
                        const domainContainer = document.getElementById('domainAssessments');
                        if (domainContainer && !domainContainer.hasChildNodes()) {
                            console.log('Initializing domain assessments (immediate)...');
                            initDomainAssessments();
                        }
                    }, 200);
                }
            }
        });
        
        async function calculateFullSavings() {
            console.log('calculateFullSavings called');
            
            const errorDiv = document.getElementById('savingsError');
            const resultDiv = document.getElementById('savingsResult');
            
            if (!errorDiv || !resultDiv) {
                console.error('Error: savingsError or savingsResult elements not found');
                alert('Error: Required elements not found. Please refresh the page.');
                return;
            }
            
            errorDiv.style.display = 'none';
            resultDiv.style.display = 'none';
            
            try {
                // Collect domain assessments
                const domainAssessments = {};
                DOMAINS.forEach(domain => {
                    const levelEl = document.getElementById(`domain_${domain.key}_level`);
                    const descEl = document.getElementById(`domain_${domain.key}_desc`);
                    
                    if (levelEl && descEl) {
                        const level = levelEl.value;
                        const desc = descEl.value;
                        
                        if (level && level !== 'no') {
                            domainAssessments[domain.key] = {
                                domain: domain.key,
                                level: level,
                                description: desc || `${level} needs in ${domain.key}`
                            };
                        }
                    }
                });
                
                console.log('Domain assessments collected:', Object.keys(domainAssessments).length);
                
                // Build patient profile
                const ageEl = document.getElementById('savingsAge');
                const careTypeEl = document.getElementById('savingsCareType');
                const postcodeEl = document.getElementById('savingsPostcode');
                
                if (!ageEl || !careTypeEl || !postcodeEl) {
                    throw new Error('Required form fields not found. Please ensure all fields are present.');
                }
                
                const patientProfile = {
                    age: parseInt(ageEl.value) || 80,
                    domain_assessments: domainAssessments,
                    has_primary_health_need: document.getElementById('savingsPrimaryHealthNeed')?.checked || false,
                    requires_nursing_care: document.getElementById('savingsRequiresNursingCare')?.checked || false,
                    has_peg_feeding: document.getElementById('savingsPegFeeding')?.checked || false,
                    has_tracheostomy: document.getElementById('savingsTracheostomy')?.checked || false,
                    requires_injections: document.getElementById('savingsRequiresInjections')?.checked || false,
                    requires_ventilator: document.getElementById('savingsRequiresVentilator')?.checked || false,
                    requires_dialysis: document.getElementById('savingsRequiresDialysis')?.checked || false,
                    has_unpredictable_needs: document.getElementById('savingsUnpredictableNeeds')?.checked || false,
                    has_fluctuating_condition: document.getElementById('savingsFluctuatingCondition')?.checked || false,
                    has_high_risk_behaviours: document.getElementById('savingsHighRiskBehaviours')?.checked || false,
                    capital_assets: parseFloat(document.getElementById('savingsCapitalAssets')?.value) || 0,
                    weekly_income: parseFloat(document.getElementById('savingsWeeklyIncome')?.value) || 0,
                    care_type: careTypeEl.value,
                    is_permanent_care: document.getElementById('savingsIsPermanentCare')?.checked || false
                };
                
                // Add property if exists
                const hasPropertyEl = document.getElementById('savingsHasProperty');
                if (hasPropertyEl && hasPropertyEl.checked) {
                    patientProfile.property = {
                        value: parseFloat(document.getElementById('savingsPropertyValue')?.value) || 0,
                        is_main_residence: document.getElementById('savingsIsMainResidence')?.checked || false,
                        has_qualifying_relative: document.getElementById('savingsHasQualifyingRelative')?.checked || false,
                        qualifying_relative_details: document.getElementById('savingsQualifyingRelativeDetails')?.value || null
                    };
                }
                
                // Get postcode for pricing
                const postcode = postcodeEl.value.trim() || null;
                const careType = patientProfile.care_type;
                
                console.log('Sending request:', { postcode, careType, domainCount: Object.keys(domainAssessments).length });
                
                // Show loading state
                errorDiv.textContent = 'Calculating funding eligibility...';
                errorDiv.style.display = 'block';
                errorDiv.style.background = '#e7f3ff';
                errorDiv.style.borderLeft = '4px solid #2196F3';
                errorDiv.style.color = '#1976D2';
                errorDiv.style.padding = '15px';
                errorDiv.style.borderRadius = '4px';
                errorDiv.className = '';
                
                const requestBody = {
                    patient_profile: patientProfile,
                    postcode: postcode,
                    care_type: careType,
                    user_id: 'web_user',
                    use_cache: true
                };
                
                console.log('Request body:', JSON.stringify(requestBody, null, 2));
                
                const response = await fetch('http://localhost:8001/api/funding/calculate-full', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        console.error('Error response:', errorData);
                        errorMessage = errorData.detail || errorData.message || JSON.stringify(errorData);
                    } catch (e) {
                        const errorText = await response.text();
                        console.error('Error text:', errorText);
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                console.log('Success! Result received:', result);
                
                errorDiv.style.display = 'none';
                displayFullSavingsResult(result);
                
            } catch (error) {
                console.error('Error calculating savings:', error);
                errorDiv.className = 'error';
                errorDiv.style.background = '#f8d7da';
                errorDiv.style.borderLeft = '4px solid #dc3545';
                errorDiv.style.color = '#721c24';
                errorDiv.style.padding = '15px';
                errorDiv.style.borderRadius = '4px';
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
                
                // Also show alert for debugging
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:8001\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.');
                }
            }
        }
        
        function displayFullSavingsResult(result) {
            const resultDiv = document.getElementById('savingsResult');
            const chc = result.chc_eligibility;
            const la = result.la_support;
            const dpa = result.dpa_eligibility;
            const savings = result.savings;
            
            const chcColor = chc.probability_percent >= 70 ? '#28a745' : chc.probability_percent >= 50 ? '#ffc107' : '#dc3545';
            const chcEmoji = chc.is_likely_eligible ? '‚úÖ' : '‚ö†Ô∏è';
            
            resultDiv.innerHTML = `
                <div style="background: #fff; border-radius: 8px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <!-- CHC Eligibility -->
                    <div style="margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid ${chcColor};">
                        <h3 style="margin-top: 0; color: ${chcColor};">
                            ${chcEmoji} CHC Eligibility Assessment
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
                            <div>
                                <div style="font-size: 36px; font-weight: bold; color: ${chcColor};">
                                    ${chc.probability_percent}%
                                </div>
                                <div style="color: #666;">CHC Probability</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #333;">
                                    ${chc.threshold_category.replace('_', ' ').toUpperCase()}
                                </div>
                                <div style="color: #666;">Threshold Category</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: ${chcColor};">
                                    ${chc.is_likely_eligible ? 'Likely Eligible' : 'Review Required'}
                                </div>
                                <div style="color: #666;">Status</div>
                            </div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 4px; margin-top: 15px;">
                            <div style="background: #e0e0e0; height: 30px; border-radius: 15px; overflow: hidden;">
                                <div style="background: ${chcColor}; height: 100%; width: ${chc.probability_percent}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <p style="margin-top: 15px; color: #666;"><strong>Reasoning:</strong> ${chc.reasoning}</p>
                        ${chc.key_factors && chc.key_factors.length > 0 ? `
                            <div style="margin-top: 15px;">
                                <strong>Key Factors:</strong>
                                <ul style="margin: 10px 0 0 20px;">
                                    ${chc.key_factors.map(f => `<li>${f}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${chc.bonuses_applied && chc.bonuses_applied.length > 0 ? `
                            <div style="margin-top: 15px;">
                                <strong>Bonuses Applied:</strong>
                                <ul style="margin: 10px 0 0 20px;">
                                    ${chc.bonuses_applied.map(b => `<li>${b.replace('_', ' ')}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- LA Support -->
                    <div style="margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #2196F3;">
                        <h3 style="margin-top: 0; color: #2196F3;">üèõÔ∏è Local Authority Support</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
                            <div>
                                <div style="font-size: 32px; font-weight: bold; color: #2196F3;">
                                    ${la.top_up_probability_percent}%
                                </div>
                                <div style="color: #666;">Top-up Probability</div>
                            </div>
                            <div>
                                <div style="font-size: 32px; font-weight: bold; color: #2196F3;">
                                    ${la.full_support_probability_percent}%
                                </div>
                                <div style="color: #666;">Full Support Probability</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #333;">
                                    ¬£${la.capital_assessed.toLocaleString()}
                                </div>
                                <div style="color: #666;">Capital Assessed</div>
                            </div>
                        </div>
                        <p style="margin-top: 15px; color: #666;"><strong>Reasoning:</strong> ${la.reasoning}</p>
                        ${la.weekly_contribution ? `
                            <p style="margin-top: 10px; color: #666;">
                                <strong>Weekly Contribution:</strong> ¬£${la.weekly_contribution.toFixed(2)}
                            </p>
                        ` : ''}
                    </div>
                    
                    <!-- DPA -->
                    <div style="margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid ${dpa.is_eligible ? '#28a745' : '#ffc107'};">
                        <h3 style="margin-top: 0; color: ${dpa.is_eligible ? '#28a745' : '#ffc107'};">
                            üè† Deferred Payment Agreement
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0;">
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: ${dpa.is_eligible ? '#28a745' : '#ffc107'};">
                                    ${dpa.is_eligible ? '‚úÖ Eligible' : '‚ùå Not Eligible'}
                                </div>
                                <div style="color: #666;">DPA Status</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: ${dpa.property_disregarded ? '#28a745' : '#666'};">
                                    ${dpa.property_disregarded ? '‚úÖ Yes' : '‚ùå No'}
                                </div>
                                <div style="color: #666;">Property Disregarded</div>
                            </div>
                        </div>
                        <p style="margin-top: 15px; color: #666;"><strong>Reasoning:</strong> ${dpa.reasoning}</p>
                    </div>
                    
                    <!-- Savings -->
                    <div style="margin-bottom: 30px; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                        <h3 style="margin-top: 0; color: white;">üí∞ Potential Savings</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 30px 0;">
                            <div style="text-align: center;">
                                <div style="font-size: 36px; font-weight: bold;">¬£${savings.weekly_savings.toFixed(2)}</div>
                                <div style="font-size: 14px; opacity: 0.9;">Weekly Savings</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 36px; font-weight: bold;">¬£${Math.round(savings.annual_gbp).toLocaleString()}</div>
                                <div style="font-size: 14px; opacity: 0.9;">Annual Savings</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 36px; font-weight: bold;">¬£${Math.round(savings.five_year_gbp).toLocaleString()}</div>
                                <div style="font-size: 14px; opacity: 0.9;">5-Year Savings</div>
                            </div>
                            ${savings.lifetime_gbp ? `
                                <div style="text-align: center;">
                                    <div style="font-size: 36px; font-weight: bold;">¬£${Math.round(savings.lifetime_gbp).toLocaleString()}</div>
                                    <div style="font-size: 14px; opacity: 0.9;">Lifetime Estimate</div>
                                </div>
                            ` : '<div></div>'}
                        </div>
                    </div>
                    
                    <!-- Recommendations -->
                    ${result.recommendations && result.recommendations.length > 0 ? `
                        <div style="margin-bottom: 30px; padding: 20px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
                            <h3 style="margin-top: 0; color: #155724;">üìã Recommendations</h3>
                            <ul style="margin: 15px 0 0 20px; color: #155724;">
                                ${result.recommendations.map(r => `<li style="margin-bottom: 10px;">${r}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <!-- Actions -->
                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button class="btn" onclick="downloadSavingsPDF()" style="flex: 1;">
                            üìÑ Download PDF Report
                        </button>
                    </div>
                </div>
            `;
            
            resultDiv.style.display = 'block';
        }
        
        // Legacy calculateSavings function (kept for backward compatibility)
        async function calculateSavings(event) {
            if (event) event.preventDefault();
            // Redirect to new function
            await calculateFullSavings();
        }
        
        // Initial load
        loadRegions().then(() => loadData());
    </script>
</body>
</html>

